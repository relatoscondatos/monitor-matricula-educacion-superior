<!doctype html>
<notebook theme="glacier">
  <title>Análisis de Trayectorias Educativas: Distribución de Estudiantes por Institución según Rendimiento Escolar</title>
  <script id="1" type="text/markdown">
    # Análisis de Trayectorias Educativas: Distribución de Estudiantes por Institución según Rendimiento Escolar

    ## Descripción

    Este análisis examina las decisiones de educación superior de estudiantes egresados de establecimientos de educación media, considerando su perfil de rendimiento académico (percentil de rendimiento escolar).

    El estudio busca identificar patrones más complejos que van más allá de asociaciones generales entre colegios y universidades específicas, revelando cómo el rendimiento académico influye en las elecciones institucionales y cómo estos patrones pueden evolucionar en el tiempo.

    ### Objetivos del análisis:
    - Identificar las instituciones de educación superior preferidas por estudiantes según su percentil de rendimiento
    - Analizar la estabilidad o variación de estos patrones a lo largo del tiempo
    - Proporcionar evidencia empírica sobre las trayectorias educativas en Chile

    ---

    **Fuente de datos:** Datos Abiertos del Ministerio de Educación de Chile
    **Última actualización:** Datos disponibles hasta 2023
  </script>
  <script id="30" type="text/markdown">
    <div class="controls-section">

    ## Selección de Parámetros

    Utilice los controles a continuación para explorar los datos de diferentes establecimientos educacionales y años de egreso:

    </div>
  </script>
  <script id="17" type="text/x-typescript">
    const selectRBD = view(
      Inputs.select(
        [...new Set(data_multiple_rbds.map(d => d.rbd))].sort(),
        {
          label: "RBD:",
          value: 8888,
          format: d => `${dictEstablecimientos[d].NOM_RBD} (${dictEstablecimientos[d].NOM_COM_RBD})`
        }
      )
    );
  </script>
  <script id="10" type="text/x-typescript">

    const selectAño = view(
      Inputs.select(
        _.range(2006, 2024, 1),
        {
          label: "Año egreso Ens. Media:",
          value:2023
        }
      )
    );
  </script>
  <script id="31" type="text/markdown">
    <div class="chart-container">

    ## Distribución de Estudiantes por Institución y Percentil de Rendimiento

    **Establecimiento: ${dictEstablecimientos[selectRBD].NOM_RBD} (${dictEstablecimientos[selectRBD].NOM_COM_RBD}) - RBD: ${selectRBD} | Año de Egreso: ${selectAño}**

    El siguiente gráfico muestra la distribución de estudiantes según su percentil de rendimiento escolar y las instituciones de educación superior que seleccionaron. Las instituciones se agrupan destacando las 5 principales por cantidad de estudiantes, mientras que el resto se agrupa en la categoría "otras".

    **Ejes del gráfico:**
    - **Eje X (horizontal)**: Número de estudiantes
    - **Eje Y (vertical)**: Percentil de rendimiento escolar (0-100)

    </div>
  </script>
  <script id="14" type="text/x-typescript">
    const dataPlot = data_multiple_rbds.filter(d => d.rbd == selectRBD &&  d.agno_egreso == selectAño);

    // Get top 5 institutions by ranking for the selected year
    const top5 = _.chain(dataPlot)
        .filter(d => d.ranking_inst <= 5)
        .uniqBy('nomb_inst')
        .orderBy('ranking_inst')
        .map('nomb_inst')
        .value();


    display(Plot.plot({
      width,
        title: `${dictEstablecimientos[selectRBD].NOM_RBD} - Año ${selectAño}`,
        x: {
            label: "Número de estudiantes"
        },
        y: {
            label: "Percentil de rendimiento escolar"
        },
        color: {
            domain: _.concat(top5, "otras"),
            range: _.concat(
                d3.schemeCategory10.slice(0, top5.length),
                "lightgrey"
            ),
            legend: true
        },
        marks: [
            Plot.barX(dataPlot, {
                x: "estudiantes",
                y: (d) => +d["percentil"],
                fill: (d) => (d.ranking_inst <= 5) ? d.nomb_inst : "otras",
                sort: {z:"x"},
            channels: {
                    "Institución": "nomb_inst",
                    "Estudiantes": "estudiantes",
                    "Percentil": "percentil"
                },
                tip: true
            })
        ]
    }));
  </script>
  <script id="26" type="text/markdown">
    <div class="summary-section">

    ## Análisis por Segmentos de Rendimiento

    **Establecimiento: ${dictEstablecimientos[selectRBD].NOM_RBD} (${dictEstablecimientos[selectRBD].NOM_COM_RBD}) - RBD: ${selectRBD} | Año de Egreso: ${selectAño}**

    ${generateInstitutionSummaryMD(selectRBD, selectAño)}

    </div>
  </script>
  <script id="28" type="text/markdown">
    ---

    ## Aspectos Técnicos y Metodológicos

    ### Fuentes de Datos

    Los datos utilizados en este análisis provienen de los **Datos Abiertos del Ministerio de Educación de Chile**, específicamente:

    1. **Datos de Rendimiento Escolar (NEM y Percentil)**: Información sobre el rendimiento académico de estudiantes egresados de educación media hasta 2023
    2. **Registros Históricos de Matrícula Escolar**: Datos de matrícula en establecimientos educacionales (2004-2024)
    3. **Datos de Matrícula en Educación Superior**: Registros de matrícula de estudiantes en instituciones de educación superior

    ### Procesamiento General de Datos

    #### 1. Extracción y Preprocesamiento
    - **Extracción**: Se obtienen los archivos del repositorio de datos abiertos del MINEDUC para todos los años disponibles
    - **Identificación de estudiantes**: Se identifican estudiantes que han estado matriculados en cada establecimiento mediante revisión de registros históricos de matrícula (2004-2024)
    - **Creación de bases reducidas**: Para cada establecimiento se genera una base de datos histórica que incluye:
      - Matrícula escolar
      - Egreso de enseñanza media
      - Matrícula en educación superior
      - Asistencia anual
      - Clasificación SEP (estudiantes prioritarios y preferentes)

    #### 2. Almacenamiento
    - Los datos procesados se almacenan por establecimiento en formato Parquet
    - Se mantienen en repositorio GitHub para facilitar consultas específicas posteriores

    ### Procesamiento Específico para este Análisis

    #### 1. Identificación de Trayectorias Educativas
    - Para cada estudiante egresado de enseñanza media del establecimiento analizado, se identifica la **primera institución de educación superior** en la que se matriculó
    - Esta primera matrícula se considera como la decisión educativa principal del estudiante

    #### 2. Construcción de la Tabla de Análisis
    Se genera una tabla agregada que contiene:
    - **Año de egreso** de enseñanza media
    - **Percentil de rendimiento** del estudiante
    - **Institución de educación superior** (primera matrícula)
    - **Número de estudiantes** por cada combinación de las variables anteriores

    ### Variables Principales

    - **RBD (Rol Base de Datos)**: Identificador único del establecimiento educacional
    - **Año de Egreso**: Año de egreso de educación media
    - **Percentil de Rendimiento**: Posición relativa del estudiante dentro de su cohorte del mismo establecimiento (0-100). Este indicador se calcula a partir del ranking de notas obtenido por cada estudiante dentro de su propio establecimiento, mostrando su posición relativa en comparación con sus compañeros de generación del mismo colegio, sin establecer comparaciones entre distintos establecimientos
    - **Institución de Educación Superior**: Primera institución donde el estudiante se matriculó tras egresar de enseñanza media

    ### Criterios de Visualización y Análisis

    #### Gráfico de Distribución por Percentiles
    - **Destacado de instituciones**: Se identifican las **5 instituciones con mayor número total de estudiantes** para el establecimiento y año seleccionado, considerando todos los percentiles de rendimiento
    - **Agrupación**: Las instituciones que no están entre las 5 principales se agrupan en la categoría "otras" para simplificar la visualización
    - **Ordenamiento**: Las instituciones se ordenan por su ranking total de estudiantes recibidos

    #### Análisis por Segmentos de Rendimiento
    Para el análisis por rangos de percentiles se aplican los siguientes criterios:

    - **Segmento Superior** (percentiles 10-30): Estudiantes con mejor rendimiento relativo
    - **Segmento Intermedio** (percentiles 40-70): Estudiantes con rendimiento medio
    - **Segmento Inferior** (percentiles 80-100): Estudiantes con menor rendimiento relativo

    **Criterio de identificación de instituciones principales por segmento:**
    - Se identifican las instituciones de educación superior que, en conjunto, **concentran al menos el 60% de los estudiantes** de cada segmento de rendimiento
    - Este umbral permite identificar las instituciones más relevantes para cada grupo, destacando patrones de concentración institucional según el rendimiento académico
    - Las instituciones se ordenan por cantidad de estudiantes dentro de cada segmento hasta alcanzar o superar el 60% del total

    ### Consideraciones Metodológicas

    #### Decisiones de Procesamiento
    - **Primera matrícula**: Se considera únicamente la primera institución de educación superior donde se matriculó cada estudiante, asumiendo que representa su decisión educativa principal
    - **Percentil intra-establecimiento**: Los percentiles se calculan dentro de cada establecimiento, permitiendo comparaciones internas pero no entre colegios diferentes

    #### Agregación de Datos
    - Las instituciones se clasifican y priorizan según la cantidad de estudiantes que reciben de cada establecimiento
    - Se destacan las 5 instituciones principales por año, agrupando el resto en la categoría "otras"

    ### Limitaciones

    - **Cobertura**: El análisis considera únicamente estudiantes que efectivamente se matricularon en educación superior
    - **Temporalidad**: Los datos de egreso están disponibles hasta 2023
    - **Variables no consideradas**: No se incluyen variables socioeconómicas adicionales que podrían influir en las decisiones educativas
    - **Alcance institucional**: La información se limita a instituciones formalmente reconocidas en el sistema educativo chileno
    - **Trayectorias múltiples**: No se consideran cambios de institución posteriores a la primera matrícula

    ### Reproducibilidad

    Los datos procesados y el código de análisis están disponibles públicamente, permitiendo la replicación y extensión de este estudio para otros establecimientos educacionales.

    ---

    ## Autor

    **Ernesto Laval** ([@elaval](https://x.com/elaval))

    ---

    *Esta sección documenta el proceso completo desde la extracción de datos hasta la generación de visualizaciones, asegurando la transparencia y reproducibilidad del análisis.*
  </script>
  <script id="35" type="text/x-typescript" pinned="">
    const establecimientosSeleccionados = [
    5666,
    8473,
    8485,
    8487,
    8862,
    8888,
    8906,
    9046,
    25654]; // Add more RBDs as needed
  </script>
  <script id="12" type="application/sql" hidden="" database="duckdb" output="data_multiple_rbds">
    WITH estudiantes_rbd AS (
      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/5666/NEM_y_Percentil_Jovenes_5666.parquet'
      WHERE RBD = 5666
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8473/NEM_y_Percentil_Jovenes_8473.parquet'
      WHERE RBD = 8473
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8485/NEM_y_Percentil_Jovenes_8485.parquet'
      WHERE RBD = 8485
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8487/NEM_y_Percentil_Jovenes_8487.parquet'
      WHERE RBD = 8487
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8862/NEM_y_Percentil_Jovenes_8862.parquet'
      WHERE RBD = 8862
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8888/NEM_y_Percentil_Jovenes_8888.parquet'
      WHERE RBD = 8888
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8906/NEM_y_Percentil_Jovenes_8906.parquet'
      WHERE RBD = 8906
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/9046/NEM_y_Percentil_Jovenes_9046.parquet'
      WHERE RBD = 9046
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/25654/NEM_y_Percentil_Jovenes_25654.parquet'
      WHERE RBD = 25654
      )
    ),

    matriculas_rbd AS (
      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/5666/Matricula_Ed_Superior_5666.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8473/Matricula_Ed_Superior_8473.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8485/Matricula_Ed_Superior_8485.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8487/Matricula_Ed_Superior_8487.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8862/Matricula_Ed_Superior_8862.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8888/Matricula_Ed_Superior_8888.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8906/Matricula_Ed_Superior_8906.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/9046/Matricula_Ed_Superior_9046.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/25654/Matricula_Ed_Superior_25654.parquet')
    ),

    matriculas_con_percentil AS (
      SELECT
        nem.rbd,
        nem.mrun,
        agno_egreso,
        percentil::INT AS percentil,
        cat_periodo,
        nomb_inst
      FROM estudiantes_rbd nem
      JOIN matriculas_rbd es
        ON nem.mrun = es.mrun
    ),

    primera_matricula_por_estudiante AS (
      SELECT
        rbd,
        mrun,
        percentil,
        agno_egreso,
        MIN(cat_periodo) AS cat_periodo,
        FIRST(nomb_inst ORDER BY cat_periodo) AS nomb_inst
      FROM matriculas_con_percentil
      GROUP BY rbd, mrun, percentil, agno_egreso
    ),

    -- Calcular ranking de todas las instituciones por año y RBD (basado en total de estudiantes)
    ranking_instituciones AS (
      SELECT
        rbd,
        agno_egreso,
        nomb_inst,
        COUNT(*) AS total_estudiantes,
        ROW_NUMBER() OVER (PARTITION BY rbd, agno_egreso ORDER BY COUNT(*) DESC) AS ranking_inst
      FROM primera_matricula_por_estudiante
      GROUP BY rbd, agno_egreso, nomb_inst
    ),

    -- Calcular top 5 instituciones por año y RBD para percentiles <= 30
    top5_por_año AS (
      SELECT
        rbd,
        agno_egreso,
        nomb_inst,
        SUM(CASE WHEN percentil <= 30 THEN 1 ELSE 0 END) AS estudiantes_top_deciles,
        ROW_NUMBER() OVER (PARTITION BY rbd, agno_egreso ORDER BY SUM(CASE WHEN percentil <= 30 THEN 1 ELSE 0 END) DESC) AS ranking_top_deciles
      FROM primera_matricula_por_estudiante
      GROUP BY rbd, agno_egreso, nomb_inst
    ),

    instituciones_top5 AS (
      SELECT
        rbd,
        agno_egreso,
        nomb_inst
      FROM top5_por_año
      WHERE ranking_top_deciles <= 5
    ),

    datos_finales AS (
      SELECT
        rbd,
        agno_egreso,
        percentil,
        nomb_inst,
        COUNT(*) AS estudiantes
      FROM primera_matricula_por_estudiante
      GROUP BY rbd, agno_egreso, percentil, nomb_inst
    )

    SELECT
      df.rbd,
      df.agno_egreso,
      df.percentil,
      df.nomb_inst,
      df.estudiantes,
      ri.ranking_inst
    FROM datos_finales df
    LEFT JOIN ranking_instituciones ri
      ON df.rbd = ri.rbd
      AND df.agno_egreso = ri.agno_egreso
      AND df.nomb_inst = ri.nomb_inst
    ORDER BY df.rbd, df.agno_egreso, df.percentil, df.estudiantes DESC
  </script>
  <script id="44" type="module">
    // Helper function to generate SQL UNION statements for multiple RBDs
    function generateUnionSQL(rbds, baseUrl = 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main') {

      // Generate estudiantes_rbd CTE
      const estudiantesUnions = rbds.map((rbd, index) => {
        const prefix = index === 0 ? '  (' : '\n  UNION ALL\n\n  (';
        return `${prefix}SELECT mrun,rbd,agno_egreso,percentil
      FROM '${baseUrl}/${rbd}/NEM_y_Percentil_Jovenes_${rbd}.parquet'
      WHERE RBD = ${rbd}
      )`;
      }).join('');

      // Generate matriculas_rbd CTE
      const matriculasUnions = rbds.map((rbd, index) => {
        const prefix = index === 0 ? '  (' : '\n\n  UNION ALL\n\n  (';
        return `${prefix}SELECT mrun,cat_periodo,nomb_inst
      FROM '${baseUrl}/${rbd}/Matricula_Ed_Superior_${rbd}.parquet')`;
      }).join('');

      return {
        estudiantesRbd: `WITH estudiantes_rbd AS (\n${estudiantesUnions}\n),`,
        matriculasRbd: `\nmatriculas_rbd AS (\n${matriculasUnions}\n),`,
        fullCTE: `WITH estudiantes_rbd AS (\n${estudiantesUnions}\n),\n\nmatriculas_rbd AS (\n${matriculasUnions}\n),`
      };
    }

    // Example usage with your current RBDs
    const currentRBDs = establecimientosSeleccionados;
    const sqlParts = generateUnionSQL(currentRBDs);

    // Display the generated SQL parts
    //display("Generated SQL for estudiantes_rbd:");
    //display(sqlParts.estudiantesRbd);

    //display("\nGenerated SQL for matriculas_rbd:");
    //display(sqlParts.matriculasRbd);

    //display("\nFull CTE (both parts combined):");
    //display(sqlParts.fullCTE);

    // You can also use it with your establecimientosSeleccionados array
    //display("\nUsing establecimientosSeleccionados:");
    const sqlForSelected = generateUnionSQL(establecimientosSeleccionados);
    display(sqlForSelected.fullCTE);
  </script>
  <script id="24" type="module">
    function getTopInstitutionsForLowPercentiles(rbd, agno_egreso, minPercentile = 0, maxPercentile = 30, majorityThreshold = 66) {
      // Filter data for the specified RBD and graduation year
      const filteredData = data_multiple_rbds.filter(d =>
        d.rbd == rbd && d.agno_egreso == agno_egreso
      );

      // Get data only for percentiles within the specified range
      const percentileRangeData = filteredData.filter(d =>
        d.percentil >= minPercentile && d.percentil <= maxPercentile
      );

      if (percentileRangeData.length === 0) {
        return {
          rbd: rbd,
          agno_egreso: agno_egreso,
          min_percentile: minPercentile,
          max_percentile: maxPercentile,
          majority_threshold: majorityThreshold,
          total_students_in_range: 0,
          institutions: [],
          summary: `No data found for RBD ${rbd} in year ${agno_egreso} for percentiles ${minPercentile}-${maxPercentile}`
        };
      }

      // Calculate total students in percentile range
      const totalStudentsInRange = _.sumBy(percentileRangeData, 'estudiantes');

      // Group by institution and sum students
      const institutionSummary = _.chain(percentileRangeData)
        .groupBy('nomb_inst')
        .map((group, institution) => {
          const totalStudents = _.sumBy(group, 'estudiantes');
          const percentage = (totalStudents / totalStudentsInRange) * 100;
          return {
            institution: institution,
            students: totalStudents,
            percentage: percentage,
            isMajority: percentage >= majorityThreshold
          };
        })
        .orderBy('students', 'desc')
        .value();

      // Get institutions with at least the threshold percentage of students
      const majorityInstitutions = institutionSummary.filter(inst => inst.isMajority);

      // If no single institution has majority, find combination that reaches the threshold
      let combinedMajorityInstitutions = [];
      if (majorityInstitutions.length === 0) {
        let cumulativePercentage = 0;
        for (const institution of institutionSummary) {
          combinedMajorityInstitutions.push(institution);
          cumulativePercentage += institution.percentage;
          if (cumulativePercentage >= majorityThreshold) {
            break;
          }
        }
      }

      // Create summary with institution names
      let summary;
      if (majorityInstitutions.length > 0) {
        const institutionNames = majorityInstitutions.map(inst =>
          `${inst.institution} (${inst.percentage.toFixed(1)}%)`
        ).join(', ');
        summary = `Institution(s) enrolling ≥${majorityThreshold}% of students in percentiles ${minPercentile}-${maxPercentile}: ${institutionNames}`;
      } else if (combinedMajorityInstitutions.length > 0) {
        const totalCombinedPercentage = _.sumBy(combinedMajorityInstitutions, 'percentage');
        const institutionNames = combinedMajorityInstitutions.map(inst =>
          `${inst.institution} (${inst.percentage.toFixed(1)}%)`
        ).join(', ');
        summary = `Top ${combinedMajorityInstitutions.length} institutions together enrolling ${totalCombinedPercentage.toFixed(1)}% of students in percentiles ${minPercentile}-${maxPercentile}: ${institutionNames}`;
      } else {
        summary = `No institutions found for percentiles ${minPercentile}-${maxPercentile}`;
      }

      return {
        rbd: rbd,
        agno_egreso: agno_egreso,
        min_percentile: minPercentile,
        max_percentile: maxPercentile,
        majority_threshold: majorityThreshold,
        total_students_in_range: totalStudentsInRange,
        institutions: institutionSummary,
        majority_institutions: majorityInstitutions.length > 0 ? majorityInstitutions : combinedMajorityInstitutions,
        is_combined_majority: majorityInstitutions.length === 0 && combinedMajorityInstitutions.length > 0,
        summary: summary
      };
    }

    // Example usage with current selections, percentile range [40,70] and 66% threshold
    const result = getTopInstitutionsForLowPercentiles(selectRBD, selectAño, 40, 70, 66);

    //display(result);
  </script>
  <script id="25" type="module">
    function generateInstitutionSummaryMD(rbd, agno_egreso) {
      // Get data for different percentile ranges
      const topPerformers = getTopInstitutionsForLowPercentiles(rbd, agno_egreso, 10, 30);
      const middlePerformers = getTopInstitutionsForLowPercentiles(rbd, agno_egreso, 40, 70);
      const lowPerformers = getTopInstitutionsForLowPercentiles(rbd, agno_egreso, 80, 100);

      // Helper function to create bullet list from majority institutions
      function createBulletList(institutionData) {
        if (!institutionData.majority_institutions || institutionData.majority_institutions.length === 0) {
          return "- Ninguna institución concentra la mayoría de estudiantes";
        }

        return institutionData.majority_institutions
          .map(inst => `- ${inst.institution} (${inst.percentage.toFixed(1)}%)`)
          .join('\n');
      }

      // Generate markdown text
      const markdownText = `## Instituciones seleccionadas por mayoría de estudiantes

    **En los mejores percentiles de rendimiento escolar (10 a 30):**
    ${createBulletList(topPerformers)}

    **En percentiles intermedios (40 a 70):**
    ${createBulletList(middlePerformers)}

    **En los percentiles de menor rendimiento escolar (80 a 100):**
    ${createBulletList(lowPerformers)}`;

      return markdownText;
    }

    // Generate summary for current selections
    const institutionSummaryMD = generateInstitutionSummaryMD(selectRBD, selectAño);

    //display(institutionSummaryMD);
  </script>
  <script id="22" type="module">
    // Create download button for CSV export
    const downloadButton = htl.html`<button style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">
      Download CSV
    </button>`;

    // Function to convert data to CSV
    function downloadCSV(data, filename) {
      if (!data || data.length === 0) {
        alert('No data to export');
        return;
      }

      // Get headers from the first object
      const headers = Object.keys(data[0]);

      // Create CSV content
      const csvContent = [
        headers.join(','), // Header row
        ...data.map(row =>
          headers.map(header => {
            const value = row[header];
            // Handle values that might contain commas or quotes
            if (typeof value === 'string' && (value.includes(',') || value.includes('"') || value.includes('\n'))) {
              return `"${value.replace(/"/g, '""')}"`;
            }
            return value;
          }).join(',')
        )
      ].join('\n');

      // Create and trigger download
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Add click event listener
    downloadButton.onclick = () => {
      downloadCSV(data_multiple_rbds, 'data_multiple_rbds.csv');
    };

    //display(downloadButton);
    //display(`Dataset contains ${data_multiple_rbds.length} rows`);
  </script>
  <script id="37" type="text/x-typescript">
    const dbDirectorio = await DuckDBClient.of({
      dir: FileAttachment("directorio_escolar_2024.parquet")
    });

    const dirQuery = `
    SELECT RBD, NOM_RBD, NOM_COM_RBD
    FROM dir
    WHERE RBD in (${establecimientosSeleccionados.map(d => d).join(",")})
    `;

    const establecimientos = await dbDirectorio.query(dirQuery);
    const dictEstablecimientos = {};
    [...establecimientos].forEach(d => dictEstablecimientos[d.RBD] = d);

  </script>
  <script id="42" type="text/x-typescript" pinned="">
    display(dictEstablecimientos)
  </script>
  <script id="29" type="text/html">
    <style>
      .notebook-container {
        max-width: 1200px;
        margin: 0 auto;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      }

      h1 {
        color: #2c3e50;
        border-bottom: 3px solid #3498db;
        padding-bottom: 10px;
        margin-bottom: 30px;
      }

      h2 {
        color: #34495e;
        margin-top: 40px;
        margin-bottom: 20px;
      }

      h3 {
        color: #7f8c8d;
        margin-top: 30px;
        margin-bottom: 15px;
      }

      .controls-section {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
        border-left: 4px solid #3498db;
      }

      .chart-container {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin: 20px 0;
      }

      .summary-section {
        background-color: #f1f8ff;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
        border-left: 4px solid #0366d6;
      }

      .methodology-section {
        background-color: #fafafa;
        padding: 25px;
        border-radius: 8px;
        margin: 30px 0;
        border: 1px solid #e1e4e8;
      }

      ul {
        line-height: 1.6;
      }

      li {
        margin-bottom: 8px;
      }

      hr {
        border: none;
        height: 2px;
        background: linear-gradient(to right, #3498db, transparent);
        margin: 40px 0;
      }
    </style>
  </script>
  <script id="33" type="text/markdown">
    </div>
  </script>
</notebook>
