<!doctype html>
<notebook theme="glacier">
  <title>An√°lisis de Trayectorias Educativas: Distribuci√≥n de Estudiantes por Instituci√≥n seg√∫n Rendimiento Escolar</title>
  <script id="1" type="text/markdown">
    # An√°lisis de Trayectorias Educativas: Distribuci√≥n de Estudiantes por Instituci√≥n seg√∫n Rendimiento Escolar

    ## Descripci√≥n

    Este an√°lisis examina las decisiones de educaci√≥n superior de estudiantes egresados de establecimientos de educaci√≥n media, considerando su perfil de rendimiento acad√©mico (percentil de rendimiento escolar).

    El estudio busca identificar patrones m√°s complejos que van m√°s all√° de asociaciones generales entre colegios y universidades espec√≠ficas, revelando c√≥mo el rendimiento acad√©mico influye en las elecciones institucionales y c√≥mo estos patrones pueden evolucionar en el tiempo.

    ### Objetivos del an√°lisis:
    - Identificar las instituciones de educaci√≥n superior preferidas por estudiantes seg√∫n su percentil de rendimiento
    - Analizar la estabilidad o variaci√≥n de estos patrones a lo largo del tiempo
    - Proporcionar evidencia emp√≠rica sobre las trayectorias educativas en Chile

    ---

    **Fuente de datos:** Datos Abiertos del Ministerio de Educaci√≥n de Chile

    **√öltima actualizaci√≥n:**
    * Datos de egreso de Ense√±anza Media disponibles hasta 2023
    * Datos de Matr√≠cula en Educaci√≥n Superior disponibes hasta 2025
  </script>
  <script id="30" type="text/markdown">
    <div class="controls-section">

    ## Selecci√≥n de Par√°metros

    Utilice los controles a continuaci√≥n para explorar los datos de diferentes establecimientos educacionales y a√±os de egreso:

    </div>
  </script>
  <script id="17" type="text/x-typescript">
    const selectRBD = view(
      Inputs.select(
        _.sortBy([...new Set(data_multiple_rbds.map(d => d.rbd))], d => dictEstablecimientos[d].NOM_RBD),
        {
          label: "RBD:",
          value: 8888,
          format: d => `${dictEstablecimientos[d].NOM_RBD} (${dictEstablecimientos[d].NOM_COM_RBD}) - ${getDependenciaName(dictEstablecimientos[d].COD_DEPE2)}`
        }
      )
    );
  </script>
  <script id="10" type="text/x-typescript">

    const selectA√±o = view(
      Inputs.select(
        _.range(2005, 2024, 1),
        {
          label: "A√±o egreso Ens. Media:",
          value:2023
        }
      )
    );
  </script>
  <script id="31" type="text/markdown">
    ## Distribuci√≥n de Estudiantes por Instituci√≥n y Percentil de Rendimiento

    **${dictEstablecimientos[selectRBD].NOM_RBD}** | ${dictEstablecimientos[selectRBD].NOM_COM_RBD} | ${getDependenciaName(dictEstablecimientos[selectRBD].COD_DEPE2)} | Egreso ${selectA√±o}
  </script>
  <script id="57" type="module">
    // Faceted chart showing distribution by percentile ranges and institution
    const dataForChart = data_multiple_rbds.filter(d => d.rbd == selectRBD && d.agno_egreso == selectA√±o);

    function truncateLabel(label) {
      const maxSize = 35;
      const newLabel = label.length > maxSize ? `${label.slice(0,maxSize-3)}...`: label;
      return newLabel
    }

    const rangos = ["Mayor rendimiento (10-30)", "Rendimiento intermedio (40-70)", "Menor rendimiento (80-100)"]

    // Create percentile ranges for faceting
    const dataWithRanges_pre = dataForChart.map(d => ({
      ...d,
      percentile_range: d.percentil <= 30 ? rangos[0] :
                       d.percentil <= 70 ? rangos[1]  : rangos[2] ,

      institucion: d.ranking_inst <= 5 ? d.nomb_inst : "Otra instituci√≥n",
      //institucion:  d.nomb_inst ,
      ranking_inst: d.ranking_inst,
    }));

    const dataWithRanges = _.chain(dataWithRanges_pre)
      .groupBy(d => d.percentile_range)
      .map((items,percentile_range) =>
        _.chain(items)
        .groupBy(d => d.institucion)
        .map((subitems, institucion) => ({
          percentile_range,
          institucion,
          estudiantes : _.reduce(subitems, (memo,d) => memo+d.estudiantes,0),
          ranking_inst: subitems[0].ranking_inst
        }))
        .value()
          )
      .flatten()
      .value()

    // Get top 5 institutions overall for consistent coloring
    const top5Institutions = _.chain(dataWithRanges)
      .filter(d => d.ranking_inst <= 5)
      .uniqBy(d => d.institucion)
      .sortBy(d => d.ranking_inst)
      .map(d => d.institucion)
      .value();

    display(Plot.plot({
      width,
      height: 300,
      marginLeft:200,
      title: `Distribuci√≥n por Rango de Rendimiento`,
      subtitle: `${dictEstablecimientos[selectRBD].NOM_RBD} - A√±o ${selectA√±o}`,

      facet: {
        data: dataWithRanges,
        x: "percentile_range",
        //marginLeft: 120
      },

      fx:{
        domain: rangos,
        label: "Rendimiento academico escolar (rango en percentil de egreso)"
      },

      x: {
        label: "N√∫mero de estudiantes"
      },

      y: {
        label: null,
        domain: [...top5Institutions, "Otra instituci√≥n"],
        tickFormat: truncateLabel
        //axis: null
      },

      color: {
        domain: [...top5Institutions, "Otra instituci√≥n"],
        range: [...d3.schemeCategory10.slice(0, top5Institutions.length), "lightgrey"],
        legend: true
      },

      marks: [
        Plot.barX(dataWithRanges, {
          x: "estudiantes",
          y: d => d.ranking_inst <= 5 ? d.institucion :  "Otra instituci√≥n",
          fill: d => d.ranking_inst <= 5 ? d.institucion :  "Otra instituci√≥n",
          tip: {
            channels: {
              "Instituci√≥n": "institucion",
              "Rango": "percentile_range",
              "Estudiantes": "estudiantes",
            },
            format: {
              fill:false,
              x:false,
              y:false,
              fx:false
            }
          }
        }),
        Plot.text(dataWithRanges, {
          x: "estudiantes",
          y: d => d.ranking_inst <= 5 ? d.institucion :  "Otra instituci√≥n",
          text: "estudiantes",
          textAnchor:"start",
          dx:2
        })
      ]
    }));
  </script>
  <script id="26" type="module">
    const summaryData = {
      rbd: selectRBD,
      a√±o: selectA√±o,
      establecimiento: dictEstablecimientos[selectRBD].NOM_RBD,
      comuna: dictEstablecimientos[selectRBD].NOM_COM_RBD,
      dependencia: getDependenciaName(dictEstablecimientos[selectRBD].COD_DEPE2)
    };


    display(html`<div class="summary-section">

    <h2>Detalle por Segmentos de Rendimiento</h2>
    <h3>Instituciones en que se matricula al menos el 66% de los estudiantes del segmento</h3>

    <p><strong>Establecimiento: ${summaryData.establecimiento} (${summaryData.comuna}) - ${summaryData.dependencia} | RBD: ${summaryData.rbd} | A√±o de Egreso: ${summaryData.a√±o}</strong></p>

    <div class="performance-segments">
      <div class="segment-column high-performance">
        <div class="segment-header">
          <h4>üèÜ Mayor Rendimiento</h4>
          <span class="percentile-range">Percentiles 10-30</span>
        </div>
        <div class="institutions-list">
          ${htl.html`${generateInstitutionListHTML(summaryData.rbd, summaryData.a√±o, 10, 30)}`}
        </div>
      </div>

      <div class="segment-column medium-performance">
        <div class="segment-header">
          <h4>üìä Rendimiento Intermedio</h4>
          <span class="percentile-range">Percentiles 40-70</span>
        </div>
        <div class="institutions-list">
          ${htl.html`${generateInstitutionListHTML(summaryData.rbd, summaryData.a√±o, 40, 70)}`}
        </div>
      </div>

      <div class="segment-column low-performance">
        <div class="segment-header">
          <h4>üìà Menor Rendimiento</h4>
          <span class="percentile-range">Percentiles 80-100</span>
        </div>
        <div class="institutions-list">
          ${htl.html`${generateInstitutionListHTML(summaryData.rbd, summaryData.a√±o, 80, 100)}`}
        </div>
      </div>
    </div>

    </div>`);
  </script>
  <script id="63" type="text/markdown">

        ## An√°lisis por Segmentos de Rendimiento

        **Establecimiento: ${dictEstablecimientos[selectRBD].NOM_RBD} (${dictEstablecimientos[selectRBD].NOM_COM_RBD}) - RBD: ${selectRBD} | A√±o de Egreso: ${selectA√±o}**

        ${generateInstitutionSummaryMD(selectRBD, selectA√±o)}

        </div>
  </script>
  <script id="14" type="text/x-typescript">
    const dataPlot = data_multiple_rbds.filter(d => d.rbd == selectRBD &&  d.agno_egreso == selectA√±o);

    // Get top 5 institutions by ranking for the selected year
    const top5 = _.chain(dataPlot)
        .filter(d => d.ranking_inst <= 5)
        .uniqBy('nomb_inst')
        .orderBy('ranking_inst')
        .map('nomb_inst')
        .value();


    display(Plot.plot({
      width,
        title: `Distribuci√≥n por decil de rendimiento`,
        subtitle: `${dictEstablecimientos[selectRBD].NOM_RBD} - A√±o ${selectA√±o}`,
        x: {
            label: "N√∫mero de estudiantes"
        },
        y: {
            label: "Percentil de rendimiento escolar"
        },
        color: {
            domain: _.concat(top5, "otras"),
            range: _.concat(
                d3.schemeCategory10.slice(0, top5.length),
                "lightgrey"
            ),
            legend: true
        },
        marks: [
            Plot.barX(dataPlot, {
                x: "estudiantes",
                y: (d) => +d["percentil"],
                fill: (d) => (d.ranking_inst <= 5) ? d.nomb_inst : "otras",
                sort: {z:"x"},
            channels: {
                    "Instituci√≥n": "nomb_inst",
                    "Estudiantes": "estudiantes",
                    "Percentil": "percentil"
                },
                tip: true
            })
        ]
    }));
  </script>
  <script id="50" type="text/markdown">
    ---

    ### Interpretaci√≥n del Gr√°fico

    El gr√°fico anterior muestra la distribuci√≥n de estudiantes seg√∫n su percentil de rendimiento escolar y las instituciones de educaci√≥n superior que seleccionaron.

    **C√≥mo leer el gr√°fico:**
    - **Eje X (horizontal)**: N√∫mero de estudiantes
    - **Eje Y (vertical)**: Percentil de rendimiento escolar (0-100, donde 100 representa el mejor rendimiento)
    - **Colores**: Las instituciones se agrupan destacando las 5 principales por cantidad de estudiantes, mientras que el resto se agrupa en la categor√≠a "otras"

    **Patrones a observar:**
    - Concentraci√≥n de estudiantes de alto rendimiento en ciertas instituciones
    - Distribuci√≥n de preferencias seg√∫n nivel de rendimiento acad√©mico
    - Diversidad institucional en diferentes segmentos de rendimiento
  </script>
  <script id="28" type="text/markdown">
    ---

    ## Aspectos T√©cnicos y Metodol√≥gicos

    ### Fuentes de Datos

    Los datos utilizados en este an√°lisis provienen de los **Datos Abiertos del Ministerio de Educaci√≥n de Chile**, espec√≠ficamente:

    1. **Datos de Rendimiento Escolar (NEM y Percentil)**: Informaci√≥n sobre el rendimiento acad√©mico de estudiantes egresados de educaci√≥n media hasta 2023
    2. **Registros Hist√≥ricos de Matr√≠cula Escolar**: Datos de matr√≠cula en establecimientos educacionales (2004-2024)
    3. **Datos de Matr√≠cula en Educaci√≥n Superior**: Registros de matr√≠cula de estudiantes en instituciones de educaci√≥n superior

    ### Procesamiento General de Datos

    #### 1. Extracci√≥n y Preprocesamiento
    - **Extracci√≥n**: Se obtienen los archivos del repositorio de datos abiertos del MINEDUC para todos los a√±os disponibles
    - **Identificaci√≥n de estudiantes**: Se identifican estudiantes que han estado matriculados en cada establecimiento mediante revisi√≥n de registros hist√≥ricos de matr√≠cula (2004-2024)
    - **Creaci√≥n de bases reducidas**: Para cada establecimiento se genera una base de datos hist√≥rica que incluye:
      - Matr√≠cula escolar
      - Egreso de ense√±anza media
      - Matr√≠cula en educaci√≥n superior
      - Asistencia anual
      - Clasificaci√≥n SEP (estudiantes prioritarios y preferentes)

    #### 2. Almacenamiento
    - Los datos procesados se almacenan por establecimiento en formato Parquet
    - Se mantienen en repositorio GitHub para facilitar consultas espec√≠ficas posteriores

    ### Procesamiento Espec√≠fico para este An√°lisis

    #### 1. Identificaci√≥n de Trayectorias Educativas
    - Para cada estudiante egresado de ense√±anza media del establecimiento analizado, se identifica la **primera instituci√≥n de educaci√≥n superior** en la que se matricul√≥
    - Esta primera matr√≠cula se considera como la decisi√≥n educativa principal del estudiante

    #### 2. Construcci√≥n de la Tabla de An√°lisis
    Se genera una tabla agregada que contiene:
    - **A√±o de egreso** de ense√±anza media
    - **Percentil de rendimiento** del estudiante
    - **Instituci√≥n de educaci√≥n superior** (primera matr√≠cula)
    - **N√∫mero de estudiantes** por cada combinaci√≥n de las variables anteriores

    ### Variables Principales

    - **RBD (Rol Base de Datos)**: Identificador √∫nico del establecimiento educacional
    - **A√±o de Egreso**: A√±o de egreso de educaci√≥n media
    - **Percentil de Rendimiento**: Posici√≥n relativa del estudiante dentro de su cohorte del mismo establecimiento (0-100). Este indicador se calcula a partir del ranking de notas obtenido por cada estudiante dentro de su propio establecimiento, mostrando su posici√≥n relativa en comparaci√≥n con sus compa√±eros de generaci√≥n del mismo colegio, sin establecer comparaciones entre distintos establecimientos
    - **Instituci√≥n de Educaci√≥n Superior**: Primera instituci√≥n donde el estudiante se matricul√≥ tras egresar de ense√±anza media

    ### Criterios de Visualizaci√≥n y An√°lisis

    #### Gr√°fico de Distribuci√≥n por Percentiles
    - **Destacado de instituciones**: Se identifican las **5 instituciones con mayor n√∫mero total de estudiantes** para el establecimiento y a√±o seleccionado, considerando todos los percentiles de rendimiento
    - **Agrupaci√≥n**: Las instituciones que no est√°n entre las 5 principales se agrupan en la categor√≠a "otras" para simplificar la visualizaci√≥n
    - **Ordenamiento**: Las instituciones se ordenan por su ranking total de estudiantes recibidos

    #### An√°lisis por Segmentos de Rendimiento
    Para el an√°lisis por rangos de percentiles se aplican los siguientes criterios:

    - **Segmento Superior** (percentiles 10-30): Estudiantes con mejor rendimiento relativo
    - **Segmento Intermedio** (percentiles 40-70): Estudiantes con rendimiento medio
    - **Segmento Inferior** (percentiles 80-100): Estudiantes con menor rendimiento relativo

    **Criterio de identificaci√≥n de instituciones principales por segmento:**
    - Se identifican las instituciones de educaci√≥n superior que, en conjunto, **concentran al menos el 60% de los estudiantes** de cada segmento de rendimiento
    - Este umbral permite identificar las instituciones m√°s relevantes para cada grupo, destacando patrones de concentraci√≥n institucional seg√∫n el rendimiento acad√©mico
    - Las instituciones se ordenan por cantidad de estudiantes dentro de cada segmento hasta alcanzar o superar el 60% del total

    ### Consideraciones Metodol√≥gicas

    #### Decisiones de Procesamiento
    - **Primera matr√≠cula**: Se considera √∫nicamente la primera instituci√≥n de educaci√≥n superior donde se matricul√≥ cada estudiante, asumiendo que representa su decisi√≥n educativa principal
    - **Percentil intra-establecimiento**: Los percentiles se calculan dentro de cada establecimiento, permitiendo comparaciones internas pero no entre colegios diferentes

    #### Agregaci√≥n de Datos
    - Las instituciones se clasifican y priorizan seg√∫n la cantidad de estudiantes que reciben de cada establecimiento
    - Se destacan las 5 instituciones principales por a√±o, agrupando el resto en la categor√≠a "otras"

    ### Limitaciones

    - **Cobertura**: El an√°lisis considera √∫nicamente estudiantes que efectivamente se matricularon en educaci√≥n superior
    - **Temporalidad**: Los datos de egreso est√°n disponibles hasta 2023
    - **Variables no consideradas**: No se incluyen variables socioecon√≥micas adicionales que podr√≠an influir en las decisiones educativas
    - **Alcance institucional**: La informaci√≥n se limita a instituciones formalmente reconocidas en el sistema educativo chileno
    - **Trayectorias m√∫ltiples**: No se consideran cambios de instituci√≥n posteriores a la primera matr√≠cula

    ### Reproducibilidad

    Los datos procesados y el c√≥digo de an√°lisis est√°n disponibles p√∫blicamente, permitiendo la replicaci√≥n y extensi√≥n de este estudio para otros establecimientos educacionales.

    ---

    ## Autor

    **Ernesto Laval** ([@elaval](https://x.com/elaval))

    ---
  </script>
  <script id="48" type="text/x-typescript" hidden="">
    _.sortBy(establecimientosSeleccionados, d => d).map(d => d).join(",\n")
  </script>
  <script id="35" type="text/x-typescript">
    const establecimientosSeleccionados = [
    4,
    52,
    257,
    580,
    1194,
    1515,
    2110,
    2200,
    2786,
    2935,
    2973,
    3014,
    3247,
    4163,
    4798,
    4982,
    5084,
    5570,
    5654,
    5666,
    5810,
    7329,
    7406,
    8473,
    8485,
    8487,
    8748,
    8757,
    8862,
    8877,
    8888,
    8906,
    8917,
    8928,
    8979,
    8995,
    8996,
    9046,
    9267,
    12669,
    25369,
    25645,
    25654
    ]; // Add more RBDs as needed
  </script>
  <script id="12" type="application/sql" hidden="" database="duckdb" output="data_multiple_rbds">

    WITH estudiantes_rbd AS (
      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/4/NEM_y_Percentil_Jovenes_4.parquet'
      WHERE RBD = 4
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/52/NEM_y_Percentil_Jovenes_52.parquet'
      WHERE RBD = 52
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/257/NEM_y_Percentil_Jovenes_257.parquet'
      WHERE RBD = 257
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/580/NEM_y_Percentil_Jovenes_580.parquet'
      WHERE RBD = 580
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/1194/NEM_y_Percentil_Jovenes_1194.parquet'
      WHERE RBD = 1194
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/1515/NEM_y_Percentil_Jovenes_1515.parquet'
      WHERE RBD = 1515
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/2110/NEM_y_Percentil_Jovenes_2110.parquet'
      WHERE RBD = 2110
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/2200/NEM_y_Percentil_Jovenes_2200.parquet'
      WHERE RBD = 2200
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/2786/NEM_y_Percentil_Jovenes_2786.parquet'
      WHERE RBD = 2786
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/2935/NEM_y_Percentil_Jovenes_2935.parquet'
      WHERE RBD = 2935
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/2973/NEM_y_Percentil_Jovenes_2973.parquet'
      WHERE RBD = 2973
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/3014/NEM_y_Percentil_Jovenes_3014.parquet'
      WHERE RBD = 3014
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/3247/NEM_y_Percentil_Jovenes_3247.parquet'
      WHERE RBD = 3247
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/4163/NEM_y_Percentil_Jovenes_4163.parquet'
      WHERE RBD = 4163
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/4798/NEM_y_Percentil_Jovenes_4798.parquet'
      WHERE RBD = 4798
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/4982/NEM_y_Percentil_Jovenes_4982.parquet'
      WHERE RBD = 4982
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/5084/NEM_y_Percentil_Jovenes_5084.parquet'
      WHERE RBD = 5084
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/5570/NEM_y_Percentil_Jovenes_5570.parquet'
      WHERE RBD = 5570
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/5654/NEM_y_Percentil_Jovenes_5654.parquet'
      WHERE RBD = 5654
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/5666/NEM_y_Percentil_Jovenes_5666.parquet'
      WHERE RBD = 5666
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/5810/NEM_y_Percentil_Jovenes_5810.parquet'
      WHERE RBD = 5810
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/7329/NEM_y_Percentil_Jovenes_7329.parquet'
      WHERE RBD = 7329
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/7406/NEM_y_Percentil_Jovenes_7406.parquet'
      WHERE RBD = 7406
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8473/NEM_y_Percentil_Jovenes_8473.parquet'
      WHERE RBD = 8473
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8485/NEM_y_Percentil_Jovenes_8485.parquet'
      WHERE RBD = 8485
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8487/NEM_y_Percentil_Jovenes_8487.parquet'
      WHERE RBD = 8487
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8748/NEM_y_Percentil_Jovenes_8748.parquet'
      WHERE RBD = 8748
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8757/NEM_y_Percentil_Jovenes_8757.parquet'
      WHERE RBD = 8757
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8862/NEM_y_Percentil_Jovenes_8862.parquet'
      WHERE RBD = 8862
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8877/NEM_y_Percentil_Jovenes_8877.parquet'
      WHERE RBD = 8877
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8888/NEM_y_Percentil_Jovenes_8888.parquet'
      WHERE RBD = 8888
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8906/NEM_y_Percentil_Jovenes_8906.parquet'
      WHERE RBD = 8906
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8917/NEM_y_Percentil_Jovenes_8917.parquet'
      WHERE RBD = 8917
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8928/NEM_y_Percentil_Jovenes_8928.parquet'
      WHERE RBD = 8928
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8979/NEM_y_Percentil_Jovenes_8979.parquet'
      WHERE RBD = 8979
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8995/NEM_y_Percentil_Jovenes_8995.parquet'
      WHERE RBD = 8995
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8996/NEM_y_Percentil_Jovenes_8996.parquet'
      WHERE RBD = 8996
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/9046/NEM_y_Percentil_Jovenes_9046.parquet'
      WHERE RBD = 9046
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/9267/NEM_y_Percentil_Jovenes_9267.parquet'
      WHERE RBD = 9267
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/12669/NEM_y_Percentil_Jovenes_12669.parquet'
      WHERE RBD = 12669
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/25369/NEM_y_Percentil_Jovenes_25369.parquet'
      WHERE RBD = 25369
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/25645/NEM_y_Percentil_Jovenes_25645.parquet'
      WHERE RBD = 25645
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/25654/NEM_y_Percentil_Jovenes_25654.parquet'
      WHERE RBD = 25654
      )
    ),

    matriculas_rbd AS (
      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/4/Matricula_Ed_Superior_4.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/52/Matricula_Ed_Superior_52.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/257/Matricula_Ed_Superior_257.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/580/Matricula_Ed_Superior_580.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/1194/Matricula_Ed_Superior_1194.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/1515/Matricula_Ed_Superior_1515.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/2110/Matricula_Ed_Superior_2110.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/2200/Matricula_Ed_Superior_2200.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/2786/Matricula_Ed_Superior_2786.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/2935/Matricula_Ed_Superior_2935.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/2973/Matricula_Ed_Superior_2973.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/3014/Matricula_Ed_Superior_3014.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/3247/Matricula_Ed_Superior_3247.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/4163/Matricula_Ed_Superior_4163.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/4798/Matricula_Ed_Superior_4798.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/4982/Matricula_Ed_Superior_4982.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/5084/Matricula_Ed_Superior_5084.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/5570/Matricula_Ed_Superior_5570.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/5654/Matricula_Ed_Superior_5654.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/5666/Matricula_Ed_Superior_5666.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/5810/Matricula_Ed_Superior_5810.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/7329/Matricula_Ed_Superior_7329.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/7406/Matricula_Ed_Superior_7406.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8473/Matricula_Ed_Superior_8473.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8485/Matricula_Ed_Superior_8485.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8487/Matricula_Ed_Superior_8487.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8748/Matricula_Ed_Superior_8748.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8757/Matricula_Ed_Superior_8757.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8862/Matricula_Ed_Superior_8862.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8877/Matricula_Ed_Superior_8877.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8888/Matricula_Ed_Superior_8888.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8906/Matricula_Ed_Superior_8906.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8917/Matricula_Ed_Superior_8917.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8928/Matricula_Ed_Superior_8928.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8979/Matricula_Ed_Superior_8979.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8995/Matricula_Ed_Superior_8995.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8996/Matricula_Ed_Superior_8996.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/9046/Matricula_Ed_Superior_9046.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/9267/Matricula_Ed_Superior_9267.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/12669/Matricula_Ed_Superior_12669.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/25369/Matricula_Ed_Superior_25369.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/25645/Matricula_Ed_Superior_25645.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/25654/Matricula_Ed_Superior_25654.parquet')
    ),

    matriculas_con_percentil AS (
      SELECT
        nem.rbd,
        nem.mrun,
        agno_egreso,
        percentil::INT AS percentil,
        cat_periodo,
        nomb_inst
      FROM estudiantes_rbd nem
      JOIN matriculas_rbd es
        ON nem.mrun = es.mrun
    ),

    primera_matricula_por_estudiante AS (
      SELECT
        rbd,
        mrun,
        percentil,
        agno_egreso,
        MIN(cat_periodo) AS cat_periodo,
        FIRST(nomb_inst ORDER BY cat_periodo) AS nomb_inst
      FROM matriculas_con_percentil
      GROUP BY rbd, mrun, percentil, agno_egreso
    ),

    -- Calcular ranking de todas las instituciones por a√±o y RBD (basado en total de estudiantes)
    ranking_instituciones AS (
      SELECT
        rbd,
        agno_egreso,
        nomb_inst,
        COUNT(*) AS total_estudiantes,
        ROW_NUMBER() OVER (PARTITION BY rbd, agno_egreso ORDER BY COUNT(*) DESC) AS ranking_inst
      FROM primera_matricula_por_estudiante
      GROUP BY rbd, agno_egreso, nomb_inst
    ),

    -- Calcular top 5 instituciones por a√±o y RBD para percentiles <= 30
    top5_por_a√±o AS (
      SELECT
        rbd,
        agno_egreso,
        nomb_inst,
        SUM(CASE WHEN percentil <= 30 THEN 1 ELSE 0 END) AS estudiantes_top_deciles,
        ROW_NUMBER() OVER (PARTITION BY rbd, agno_egreso ORDER BY SUM(CASE WHEN percentil <= 30 THEN 1 ELSE 0 END) DESC) AS ranking_top_deciles
      FROM primera_matricula_por_estudiante
      GROUP BY rbd, agno_egreso, nomb_inst
    ),

    instituciones_top5 AS (
      SELECT
        rbd,
        agno_egreso,
        nomb_inst
      FROM top5_por_a√±o
      WHERE ranking_top_deciles <= 5
    ),

    datos_finales AS (
      SELECT
        rbd,
        agno_egreso,
        percentil,
        nomb_inst,
        COUNT(*) AS estudiantes
      FROM primera_matricula_por_estudiante
      GROUP BY rbd, agno_egreso, percentil, nomb_inst
    )

    SELECT
      df.rbd,
      df.agno_egreso,
      df.percentil,
      df.nomb_inst,
      df.estudiantes,
      ri.ranking_inst
    FROM datos_finales df
    LEFT JOIN ranking_instituciones ri
      ON df.rbd = ri.rbd
      AND df.agno_egreso = ri.agno_egreso
      AND df.nomb_inst = ri.nomb_inst
    ORDER BY df.rbd, df.agno_egreso, df.percentil, df.estudiantes DESC
  </script>
  <script id="45" type="module">
    const sqlQuery = sqlForSelected.queryCompleta;

    // Create a container with the query text and copy button
    const container = htl.html`<div style="border: 1px solid #ddd; border-radius: 4px; padding: 15px; background-color: #f8f9fa;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h4 style="margin: 0; color: #495057;">SQL Query Completa</h4>
        <button id="copyButton" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
          üìã Copy to Clipboard
        </button>
      </div>
      <!--
      <pre style="background-color: white; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px; line-height: 1.4; margin: 0; border: 1px solid #e9ecef;"><code>${sqlQuery}</code></pre>
      -->
    </div>`;

    // Add click event listener to the copy button
    container.querySelector('#copyButton').addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(sqlQuery);

        // Visual feedback
        const button = container.querySelector('#copyButton');
        const originalText = button.textContent;
        button.textContent = '‚úÖ Copied!';
        button.style.background = '#28a745';

        // Reset button after 2 seconds
        setTimeout(() => {
          button.textContent = originalText;
          button.style.background = '#007bff';
        }, 2000);

      } catch (err) {
        console.error('Failed to copy text: ', err);
        alert('Failed to copy to clipboard. Please copy manually.');
      }
    });

    //display(container);
  </script>
  <script id="44" type="module" hidden="">
    // Helper function to generate SQL UNION statements for multiple RBDs
    function generateUnionSQL(rbds, baseUrl = 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main') {

      // Generate estudiantes_rbd CTE
      const estudiantesUnions = rbds.map((rbd, index) => {
        const prefix = index === 0 ? '  (' : '\n  UNION ALL\n\n  (';
        return `${prefix}SELECT mrun,rbd,agno_egreso,percentil
      FROM '${baseUrl}/${rbd}/NEM_y_Percentil_Jovenes_${rbd}.parquet'
      WHERE RBD = ${rbd}
      )`;
      }).join('');

      // Generate matriculas_rbd CTE
      const matriculasUnions = rbds.map((rbd, index) => {
        const prefix = index === 0 ? '  (' : '\n\n  UNION ALL\n\n  (';
        return `${prefix}SELECT mrun,cat_periodo,nomb_inst
      FROM '${baseUrl}/${rbd}/Matricula_Ed_Superior_${rbd}.parquet')`;
      }).join('');

      return {
        estudiantesRbd: `WITH estudiantes_rbd AS (\n${estudiantesUnions}\n),`,
        matriculasRbd: `\nmatriculas_rbd AS (\n${matriculasUnions}\n),`,
        fullCTE: `WITH estudiantes_rbd AS (\n${estudiantesUnions}\n),\n\nmatriculas_rbd AS (\n${matriculasUnions}\n),`,

        queryCompleta: `
    WITH estudiantes_rbd AS (\n${estudiantesUnions}\n),\n\nmatriculas_rbd AS (\n${matriculasUnions}\n),

    matriculas_con_percentil AS (
      SELECT
        nem.rbd,
        nem.mrun,
        agno_egreso,
        percentil::INT AS percentil,
        cat_periodo,
        nomb_inst
      FROM estudiantes_rbd nem
      JOIN matriculas_rbd es
        ON nem.mrun = es.mrun
    ),

    primera_matricula_por_estudiante AS (
      SELECT
        rbd,
        mrun,
        percentil,
        agno_egreso,
        MIN(cat_periodo) AS cat_periodo,
        FIRST(nomb_inst ORDER BY cat_periodo) AS nomb_inst
      FROM matriculas_con_percentil
      GROUP BY rbd, mrun, percentil, agno_egreso
    ),

    -- Calcular ranking de todas las instituciones por a√±o y RBD (basado en total de estudiantes)
    ranking_instituciones AS (
      SELECT
        rbd,
        agno_egreso,
        nomb_inst,
        COUNT(*) AS total_estudiantes,
        ROW_NUMBER() OVER (PARTITION BY rbd, agno_egreso ORDER BY COUNT(*) DESC) AS ranking_inst
      FROM primera_matricula_por_estudiante
      GROUP BY rbd, agno_egreso, nomb_inst
    ),

    -- Calcular top 5 instituciones por a√±o y RBD para percentiles <= 30
    top5_por_a√±o AS (
      SELECT
        rbd,
        agno_egreso,
        nomb_inst,
        SUM(CASE WHEN percentil <= 30 THEN 1 ELSE 0 END) AS estudiantes_top_deciles,
        ROW_NUMBER() OVER (PARTITION BY rbd, agno_egreso ORDER BY SUM(CASE WHEN percentil <= 30 THEN 1 ELSE 0 END) DESC) AS ranking_top_deciles
      FROM primera_matricula_por_estudiante
      GROUP BY rbd, agno_egreso, nomb_inst
    ),

    instituciones_top5 AS (
      SELECT
        rbd,
        agno_egreso,
        nomb_inst
      FROM top5_por_a√±o
      WHERE ranking_top_deciles <= 5
    ),

    datos_finales AS (
      SELECT
        rbd,
        agno_egreso,
        percentil,
        nomb_inst,
        COUNT(*) AS estudiantes
      FROM primera_matricula_por_estudiante
      GROUP BY rbd, agno_egreso, percentil, nomb_inst
    )

    SELECT
      df.rbd,
      df.agno_egreso,
      df.percentil,
      df.nomb_inst,
      df.estudiantes,
      ri.ranking_inst
    FROM datos_finales df
    LEFT JOIN ranking_instituciones ri
      ON df.rbd = ri.rbd
      AND df.agno_egreso = ri.agno_egreso
      AND df.nomb_inst = ri.nomb_inst
    ORDER BY df.rbd, df.agno_egreso, df.percentil, df.estudiantes DESC`


      };
    }

    // Example usage with your current RBDs
    const currentRBDs = establecimientosSeleccionados;
    const sqlParts = generateUnionSQL(currentRBDs);

    // Display the generated SQL parts
    //display("Generated SQL for estudiantes_rbd:");
    //display(sqlParts.estudiantesRbd);

    //display("\nGenerated SQL for matriculas_rbd:");
    //display(sqlParts.matriculasRbd);

    //display("\nFull CTE (both parts combined):");
    //display(sqlParts.fullCTE);

    // You can also use it with your establecimientosSeleccionados array
    //display("\nUsing establecimientosSeleccionados:");
    const sqlForSelected = generateUnionSQL(establecimientosSeleccionados);

  </script>
  <script id="24" type="module">
    function getTopInstitutionsForLowPercentiles(rbd, agno_egreso, minPercentile = 0, maxPercentile = 30, majorityThreshold = 66) {
      // Filter data for the specified RBD and graduation year
      const filteredData = data_multiple_rbds.filter(d =>
        d.rbd == rbd && d.agno_egreso == agno_egreso
      );

      // Get data only for percentiles within the specified range
      const percentileRangeData = filteredData.filter(d =>
        d.percentil >= minPercentile && d.percentil <= maxPercentile
      );

      if (percentileRangeData.length === 0) {
        return {
          rbd: rbd,
          agno_egreso: agno_egreso,
          min_percentile: minPercentile,
          max_percentile: maxPercentile,
          majority_threshold: majorityThreshold,
          total_students_in_range: 0,
          institutions: [],
          summary: `No data found for RBD ${rbd} in year ${agno_egreso} for percentiles ${minPercentile}-${maxPercentile}`
        };
      }

      // Calculate total students in percentile range
      const totalStudentsInRange = _.sumBy(percentileRangeData, 'estudiantes');

      // Group by institution and sum students
      const institutionSummary = _.chain(percentileRangeData)
        .groupBy('nomb_inst')
        .map((group, institution) => {
          const totalStudents = _.sumBy(group, 'estudiantes');
          const percentage = (totalStudents / totalStudentsInRange) * 100;
          return {
            institution: institution,
            students: totalStudents,
            percentage: percentage,
            isMajority: percentage >= majorityThreshold
          };
        })
        .orderBy('students', 'desc')
        .value();

      // Get institutions with at least the threshold percentage of students
      const majorityInstitutions = institutionSummary.filter(inst => inst.isMajority);

      // If no single institution has majority, find combination that reaches the threshold
      let combinedMajorityInstitutions = [];
      if (majorityInstitutions.length === 0) {
        let cumulativePercentage = 0;
        for (const institution of institutionSummary) {
          combinedMajorityInstitutions.push(institution);
          cumulativePercentage += institution.percentage;
          if (cumulativePercentage >= majorityThreshold) {
            break;
          }
        }
      }

      // Create summary with institution names
      let summary;
      if (majorityInstitutions.length > 0) {
        const institutionNames = majorityInstitutions.map(inst =>
          `${inst.institution} (${inst.percentage.toFixed(1)}%)`
        ).join(', ');
        summary = `Institution(s) enrolling ‚â•${majorityThreshold}% of students in percentiles ${minPercentile}-${maxPercentile}: ${institutionNames}`;
      } else if (combinedMajorityInstitutions.length > 0) {
        const totalCombinedPercentage = _.sumBy(combinedMajorityInstitutions, 'percentage');
        const institutionNames = combinedMajorityInstitutions.map(inst =>
          `${inst.institution} (${inst.percentage.toFixed(1)}%)`
        ).join(', ');
        summary = `Top ${combinedMajorityInstitutions.length} institutions together enrolling ${totalCombinedPercentage.toFixed(1)}% of students in percentiles ${minPercentile}-${maxPercentile}: ${institutionNames}`;
      } else {
        summary = `No institutions found for percentiles ${minPercentile}-${maxPercentile}`;
      }

      return {
        rbd: rbd,
        agno_egreso: agno_egreso,
        min_percentile: minPercentile,
        max_percentile: maxPercentile,
        majority_threshold: majorityThreshold,
        total_students_in_range: totalStudentsInRange,
        institutions: institutionSummary,
        majority_institutions: majorityInstitutions.length > 0 ? majorityInstitutions : combinedMajorityInstitutions,
        is_combined_majority: majorityInstitutions.length === 0 && combinedMajorityInstitutions.length > 0,
        summary: summary
      };
    }

    // Example usage with current selections, percentile range [40,70] and 66% threshold
    const result = getTopInstitutionsForLowPercentiles(selectRBD, selectA√±o, 40, 70, 66);

    //display(result);
  </script>
  <script id="65" type="text/x-typescript" pinned="">
    const items = ["Apples", "Pears", "Berries"];
    const segData = getTopInstitutionsForLowPercentiles(8888, 2023, 10, 30);
    const myHtml = html`<ul>${segData.majority_institutions.map(d => html`<li>${d.institution}</li>`)}</ul>`
    display(segData)
    display(html`<ul>${segData.majority_institutions.map(d => html`<li>${d.institution}</li>`)}${myHtml}</ul>`)
    display(segData)

  </script>
  <script id="64" type="text/x-typescript" pinned="">
    const a = `<h1>Test</h1>`
    display(html`${generateInstitutionListHTML(8888, 2022, 10, 30)}`)
    const a2 = html`<h1>Test</h1>`;
    display(html`${a2}`);
      display(generateInstitutionListHTML(8888, 2022, 10, 30))
    display([1,1,1,1])
    display(html`${generateInstitutionListHTML(8888, 2022, 10, 30)}`)
    display(html`${generateInstitutionListHTML(8888, 2022, 10, 30)}`)
  </script>
  <script id="66" type="text/html" pinned="">
    ${html`${generateInstitutionListHTML(8888, 2022, 10, 30)}`}
    display([1,1,1,1])
    display(html`${generateInstitutionListHTML(8888, 2022, 10, 30)}`)
    display(html`${generateInstitutionListHTML(8888, 2022, 10, 30)}`)
  </script>
  <script id="58" type="module" pinned="">
    // Function to generate HTML list for institutions in each performance segment

    function generateInstitutionListHTML(rbd, agno_egreso, minPercentile, maxPercentile) {
      const data = getTopInstitutionsForLowPercentiles(rbd, agno_egreso, minPercentile, maxPercentile) ?? {};

      const total = data.total_students_in_range ?? 0;
      const list = Array.isArray(data.majority_institutions) ? data.majority_institutions : [];

      if (list.length === 0) {
        return html`
          <div class="no-data">
            <p>Ninguna instituci√≥n concentra la mayor√≠a de estudiantes</p>
            <small>Total estudiantes: ${total}</small>
          </div>
        `;
      }

      // Build an array of DOM nodes (no .join!)
      const items = list.map(inst => html`
        <div class="institution-item">
          <div class="institution-name">${inst.institution}</div>
          <div class="institution-percentage">${Number(inst.percentage).toFixed(1)}%</div>
          <div class="institution-students">${inst.students} estudiantes</div>
        </div>
      `);

      return html`
        <div class="institutions-container">
          ${items}
          <div class="segment-total">
            <strong>Total segmento: ${total} estudiantes</strong>
          </div>
        </div>
      `;
    }

  </script>
  <script id="25" type="module">
    function generateInstitutionSummaryMD(rbd, agno_egreso) {
      // Get data for different percentile ranges
      const topPerformers = getTopInstitutionsForLowPercentiles(rbd, agno_egreso, 10, 30);
      const middlePerformers = getTopInstitutionsForLowPercentiles(rbd, agno_egreso, 40, 70);
      const lowPerformers = getTopInstitutionsForLowPercentiles(rbd, agno_egreso, 80, 100);

      // Helper function to create bullet list from majority institutions
      function createBulletList(institutionData) {
        if (!institutionData.majority_institutions || institutionData.majority_institutions.length === 0) {
          return "- Ninguna instituci√≥n concentra la mayor√≠a de estudiantes";
        }

        return institutionData.majority_institutions
          .map(inst => `- ${inst.institution} (${inst.percentage.toFixed(1)}%)`)
          .join('\n');
      }

      // Generate markdown text
      const markdownText = `## Instituciones seleccionadas por mayor√≠a de estudiantes

    **En los mejores percentiles de rendimiento escolar (10 a 30):**
    ${createBulletList(topPerformers)}

    **En percentiles intermedios (40 a 70):**
    ${createBulletList(middlePerformers)}

    **En los percentiles de menor rendimiento escolar (80 a 100):**
    ${createBulletList(lowPerformers)}`;

      return markdownText;
    }

    // Generate summary for current selections
    const institutionSummaryMD = generateInstitutionSummaryMD(selectRBD, selectA√±o);

    //display(institutionSummaryMD);
  </script>
  <script id="22" type="module">
    // Create download button for CSV export
    const downloadButton = htl.html`<button style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">
      Download CSV
    </button>`;

    // Function to convert data to CSV
    function downloadCSV(data, filename) {
      if (!data || data.length === 0) {
        alert('No data to export');
        return;
      }

      // Get headers from the first object
      const headers = Object.keys(data[0]);

      // Create CSV content
      const csvContent = [
        headers.join(','), // Header row
        ...data.map(row =>
          headers.map(header => {
            const value = row[header];
            // Handle values that might contain commas or quotes
            if (typeof value === 'string' && (value.includes(',') || value.includes('"') || value.includes('\n'))) {
              return `"${value.replace(/"/g, '""')}"`;
            }
            return value;
          }).join(',')
        )
      ].join('\n');

      // Create and trigger download
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Add click event listener
    downloadButton.onclick = () => {
      downloadCSV(data_multiple_rbds, 'data_multiple_rbds.csv');
    };

    //display(downloadButton);
    //display(`Dataset contains ${data_multiple_rbds.length} rows`);
  </script>
  <script id="37" type="text/x-typescript">
    const dbDirectorio = await DuckDBClient.of({
      dir: FileAttachment("directorio_escolar_2024.parquet")
    });

    const dirQuery = `
    SELECT RBD, NOM_RBD, NOM_COM_RBD, COD_DEPE2
    FROM dir
    WHERE RBD in (${establecimientosSeleccionados.map(d => d).join(",")})
    `;

    const establecimientos = await dbDirectorio.query(dirQuery);
    const dictEstablecimientos = {};
    [...establecimientos].forEach(d => dictEstablecimientos[d.RBD] = d);

  </script>
  <script id="55" type="module" hidden="">
    // Mapping function for school dependency types
    function getDependenciaName(codDepe2) {
      const dependenciaMap = {
        1: "Municipal",
        2: "Particular Subvencionado",
        3: "Particular Pagado",
        4: "Administraci√≥n Delegada",
        5: "Servicio Local"
      };
      return dependenciaMap[codDepe2] || "No especificado";
    }
  </script>
  <script id="59" type="text/html">
    <style>
      .performance-segments {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 20px;
        margin-top: 20px;
      }

      .segment-column {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-top: 4px solid;
      }

      .segment-column.high-performance {
        border-top-color: #27ae60;
      }

      .segment-column.medium-performance {
        border-top-color: #f39c12;
      }

      .segment-column.low-performance {
        border-top-color: #e74c3c;
      }

      .segment-header {
        text-align: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
      }

      .segment-header h4 {
        margin: 0 0 8px 0;
        font-size: 1.1em;
        color: #2c3e50;
      }

      .percentile-range {
        font-size: 0.9em;
        color: #7f8c8d;
        font-weight: 500;
      }

      .institutions-container {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .institution-item {
        background: #f8f9fa;
        padding: 12px;
        border-radius: 6px;
        border-left: 3px solid #3498db;
        transition: all 0.2s ease;
      }

      .institution-item:hover {
        background: #e9ecef;
        transform: translateX(2px);
      }

      .institution-name {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 4px;
        font-size: 0.95em;
        line-height: 1.3;
      }

      .institution-percentage {
        font-size: 1.1em;
        font-weight: 700;
        color: #3498db;
        margin-bottom: 2px;
      }

      .institution-students {
        font-size: 0.85em;
        color: #7f8c8d;
      }

      .segment-total {
        margin-top: 15px;
        padding: 12px;
        background: #e8f4f8;
        border-radius: 6px;
        text-align: center;
        font-size: 0.9em;
        color: #2c3e50;
      }

      .no-data {
        text-align: center;
        padding: 20px;
        color: #7f8c8d;
      }

      .no-data p {
        margin: 0 0 8px 0;
        font-style: italic;
      }

      .no-data small {
        font-size: 0.8em;
      }

      /* Responsive design */
      @media (max-width: 1024px) {
        .performance-segments {
          grid-template-columns: 1fr;
          gap: 15px;
        }

        .segment-column {
          padding: 15px;
        }
      }

      @media (max-width: 768px) {
        .institution-name {
          font-size: 0.9em;
        }

        .segment-header h4 {
          font-size: 1em;
        }
      }
    </style>
  </script>
  <script id="29" type="text/html">
    <style>
      .notebook-container {
        max-width: 1200px;
        margin: 0 auto;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      }

      h1 {
        color: #2c3e50;
        border-bottom: 3px solid #3498db;
        padding-bottom: 10px;
        margin-bottom: 30px;
      }

      h2 {
        color: #34495e;
        margin-top: 40px;
        margin-bottom: 20px;
      }

      h3 {
        color: #7f8c8d;
        margin-top: 30px;
        margin-bottom: 15px;
      }

      .controls-section {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
        border-left: 4px solid #3498db;
      }

      .chart-container {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin: 20px 0;
      }

      .summary-section {
        background-color: #f1f8ff;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
        border-left: 4px solid #0366d6;
      }

      .methodology-section {
        background-color: #fafafa;
        padding: 25px;
        border-radius: 8px;
        margin: 30px 0;
        border: 1px solid #e1e4e8;
      }

      ul {
        line-height: 1.6;
      }

      li {
        margin-bottom: 8px;
      }

      hr {
        border: none;
        height: 2px;
        background: linear-gradient(to right, #3498db, transparent);
        margin: 40px 0;
      }
    </style>
  </script>
  <script id="33" type="text/markdown">
    </div>
  </script>
</notebook>
