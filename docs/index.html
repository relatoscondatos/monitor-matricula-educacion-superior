<!doctype html>
<notebook theme="glacier">
  <title>An√°lisis de Trayectorias Educativas: Distribuci√≥n de Estudiantes por Instituci√≥n seg√∫n Rendimiento Escolar</title>
  <script id="1" type="text/markdown">
    # An√°lisis de Trayectorias Educativas: Distribuci√≥n de Estudiantes por Instituci√≥n seg√∫n Rendimiento Escolar
    **Ernesto Laval** ([@elaval](https://x.com/elaval))

    ## Descripci√≥n

    Este an√°lisis examina las decisiones de educaci√≥n superior de estudiantes egresados de establecimientos de educaci√≥n media, considerando su perfil de rendimiento acad√©mico (percentil de rendimiento escolar).

    ### Objetivos del an√°lisis:
    - Identificar las instituciones de educaci√≥n superior preferidas por estudiantes seg√∫n su percentil de rendimiento
    - Analizar la estabilidad o variaci√≥n de estos patrones a lo largo del tiempo
    - Proporcionar evidencia emp√≠rica sobre las trayectorias educativas en Chile

    **Fuente de datos:** Datos Abiertos del Ministerio de Educaci√≥n de Chile

    ---
  </script>
  <script id="30" type="text/markdown">
    <div class="controls-section">

    ## Selecci√≥n de Par√°metros

    Se incluye una selecci√≥n de sobre 50 establecimientos de Educaci√≥n Media que representan distintas dependencias y geograf√≠as.

    Utilice los controles a continuaci√≥n para explorar los datos de diferentes establecimientos educacionales y a√±os de egreso:

    </div>
  </script>
  <script id="17" type="text/x-typescript">
    const options = _.sortBy([...new Set(data_multiple_rbds.map(d => d.rbd))], d => dictEstablecimientos[d].NOM_RBD);
    const selectRBD = view(
      Inputs.select(
        options,
        {
          label: "Establecimiento Escolar:",
          value: _.sample(options),
          format: d => `${dictEstablecimientos[d].NOM_RBD} (${dictEstablecimientos[d].NOM_COM_RBD}) - ${getDependenciaName(dictEstablecimientos[d].COD_DEPE2)}`
        }
      )
    );
  </script>
  <script id="10" type="text/x-typescript">

    const selectA√±o = view(
      Inputs.select(
        _.range(2005, 2024, 1),
        {
          label: "A√±o de egreso de Ense√±anza Media:",
          value:2023
        }
      )
    );
  </script>
  <script id="31" type="text/markdown">
    ## Distribuci√≥n de Estudiantes por Instituci√≥n y Percentil de Rendimiento

    **${dictEstablecimientos[selectRBD].NOM_RBD}** | ${dictEstablecimientos[selectRBD].NOM_COM_RBD} | ${getDependenciaName(dictEstablecimientos[selectRBD].COD_DEPE2)} | Egreso ${selectA√±o}
  </script>
  <script id="57" type="module">
    // Faceted chart showing distribution by percentile ranges and institution
    const dataForChart = data_multiple_rbds.filter(d => d.rbd == selectRBD && d.agno_egreso == selectA√±o);

    function truncateLabel(label) {
      const maxSize = 33;
      const newLabel = label.length > maxSize ? `${label.slice(0,maxSize-3)}...`: label;
      return newLabel
    }

    const rangos = ["Mayor rendimiento (10-30)", "Rendimiento intermedio (40-70)", "Menor rendimiento (80-100)"]

    // Create percentile ranges for faceting
    const dataWithRanges_pre = dataForChart.map(d => ({
      ...d,
      percentile_range: d.percentil <= 30 ? rangos[0] :
                       d.percentil <= 70 ? rangos[1]  : rangos[2] ,

      institucion: d.ranking_inst <= 5 ? d.nomb_inst : "Otra instituci√≥n",
      //institucion:  d.nomb_inst ,
      ranking_inst: d.ranking_inst,
    }));

    const dataWithRanges = _.chain(dataWithRanges_pre)
      .groupBy(d => d.percentile_range)
      .map((items,percentile_range) =>
        _.chain(items)
        .groupBy(d => d.institucion)
        .map((subitems, institucion) => ({
          percentile_range,
          institucion,
          estudiantes : _.reduce(subitems, (memo,d) => memo+d.estudiantes,0),
          ranking_inst: subitems[0].ranking_inst
        }))
        .value()
          )
      .flatten()
      .value()

    // Get top 5 institutions overall for consistent coloring
    const top5Institutions = _.chain(dataWithRanges)
      .filter(d => d.ranking_inst <= 5)
      .uniqBy(d => d.institucion)
      .sortBy(d => d.ranking_inst)
      .map(d => d.institucion)
      .value();

    const chart = (Plot.plot({
      width:900,
      height: 300,
      marginLeft:200,
      title: `Distribuci√≥n por Rango de Rendimiento`,
      subtitle: `${dictEstablecimientos[selectRBD].NOM_RBD} - A√±o ${selectA√±o}`,

      facet: {
        data: dataWithRanges,
        x: "percentile_range",
        //marginLeft: 120
      },

      fx:{
        domain: rangos,
        label: "Rendimiento academico escolar (rango en percentil de egreso)"
      },

      x: {
        label: "N√∫mero de estudiantes"
      },

      y: {
        label: null,
        domain: [...top5Institutions, "Otra instituci√≥n"],
        tickFormat: truncateLabel
        //axis: null
      },

      color: {
        domain: [...top5Institutions, "Otra instituci√≥n"],
        range: [...d3.schemeCategory10.slice(0, top5Institutions.length), "lightgrey"],
        legend: true
      },

      marks: [
        Plot.barX(dataWithRanges, {
          x: "estudiantes",
          y: d => d.ranking_inst <= 5 ? d.institucion :  "Otra instituci√≥n",
          fill: d => d.ranking_inst <= 5 ? d.institucion :  "Otra instituci√≥n",
          tip: {
            channels: {
              "Instituci√≥n": "institucion",
              "Rango": "percentile_range",
              "Estudiantes": "estudiantes",
            },
            format: {
              fill:false,
              x:false,
              y:false,
              fx:false
            }
          }
        }),
        Plot.text(dataWithRanges, {
          x: "estudiantes",
          y: d => d.ranking_inst <= 5 ? d.institucion :  "Otra instituci√≥n",
          text: "estudiantes",
          textAnchor:"start",
          dx:2
        })
      ]
    }));

    display(html`<div class="row">

      <div class="card">
      ${chart}
      </div>
    </div>`)

  </script>
  <script id="26" type="module">
    const summaryData = {
      rbd: selectRBD,
      a√±o: selectA√±o,
      establecimiento: dictEstablecimientos[selectRBD].NOM_RBD,
      comuna: dictEstablecimientos[selectRBD].NOM_COM_RBD,
      dependencia: getDependenciaName(dictEstablecimientos[selectRBD].COD_DEPE2)
    };


    display(html`<div class="summary-section">

    <h2>Detalle por Segmentos de Rendimiento</h2>
    <h3>Instituciones en que se matricula al menos el 66% de los estudiantes del segmento</h3>

    <p><strong>Establecimiento: ${summaryData.establecimiento} (${summaryData.comuna}) - ${summaryData.dependencia} | RBD: ${summaryData.rbd} | A√±o de Egreso: ${summaryData.a√±o}</strong></p>

    <div class="performance-segments">
      <div class="segment-column high-performance">
        <div class="segment-header">
          <h4>Mayor Rendimiento</h4>
          <span class="percentile-range">Percentiles 10-30</span>
        </div>
        <div class="institutions-list">
          ${htl.html`${generateInstitutionListHTML(summaryData.rbd, summaryData.a√±o, 10, 30)}`}
        </div>
      </div>

      <div class="segment-column medium-performance">
        <div class="segment-header">
          <h4>Rendimiento Intermedio</h4>
          <span class="percentile-range">Percentiles 40-70</span>
        </div>
        <div class="institutions-list">
          ${htl.html`${generateInstitutionListHTML(summaryData.rbd, summaryData.a√±o, 40, 70)}`}
        </div>
      </div>

      <div class="segment-column low-performance">
        <div class="segment-header">
          <h4>Menor Rendimiento</h4>
          <span class="percentile-range">Percentiles 80-100</span>
        </div>
        <div class="institutions-list">
          ${htl.html`${generateInstitutionListHTML(summaryData.rbd, summaryData.a√±o, 80, 100)}`}
        </div>
      </div>
    </div>

    </div>`);
  </script>
  <script id="14" type="text/x-typescript">
    const dataPlot = data_multiple_rbds.filter(d => d.rbd == selectRBD &&  d.agno_egreso == selectA√±o);

    // Get top 5 institutions by ranking for the selected year
    const top5 = _.chain(dataPlot)
        .filter(d => d.ranking_inst <= 5)
        .uniqBy('nomb_inst')
        .orderBy('ranking_inst')
        .map('nomb_inst')
        .value();


    display(Plot.plot({
      width,
        title: `Distribuci√≥n por decil de rendimiento`,
        subtitle: `${dictEstablecimientos[selectRBD].NOM_RBD} - A√±o ${selectA√±o}`,
        x: {
            label: "N√∫mero de estudiantes"
        },
        y: {
            label: "Percentil de rendimiento escolar"
        },
        color: {
            domain: _.concat(top5, "otras"),
            range: _.concat(
                d3.schemeCategory10.slice(0, top5.length),
                "lightgrey"
            ),
            legend: true
        },
        marks: [
            Plot.barX(dataPlot, {
                x: "estudiantes",
                y: (d) => +d["percentil"],
                fill: (d) => (d.ranking_inst <= 5) ? d.nomb_inst : "otras",
                sort: {z:"x"},
            channels: {
                    "Instituci√≥n": "nomb_inst",
                    "Estudiantes": "estudiantes",
                    "Percentil": "percentil"
                },
                tip: true
            })
        ]
    }));
  </script>
  <script id="50" type="text/markdown">
    ---

    ### Interpretaci√≥n del Gr√°fico

    **C√≥mo leer el gr√°fico:**
    - **Eje X**: N√∫mero de estudiantes
    - **Eje Y**: Percentil de rendimiento escolar (0-100, donde valores menores indican mejor rendimiento)
    - **Colores**: Se destacan las 5 instituciones principales por cantidad de estudiantes

    **Patrones clave a observar:**
    - Concentraci√≥n de estudiantes de alto rendimiento (percentiles bajos) en ciertas instituciones
    - Distribuci√≥n de preferencias institucionales seg√∫n nivel acad√©mico
    - Diversidad de opciones en diferentes segmentos de rendimiento
  </script>
  <script id="28" type="text/markdown">
    ---

    ## Aspectos T√©cnicos y Metodol√≥gicos

    ### Fuentes de Datos
    Los datos provienen de los **Datos Abiertos del Ministerio de Educaci√≥n de Chile**:
    - Rendimiento Escolar (NEM y Percentil) (2004 a 2023)
    - Registros de Matr√≠cula Escolar (2004-2024)
    - Matr√≠cula en Educaci√≥n Superior hasta (2007 a 2025)

    ### Metodolog√≠a
    1. **Identificaci√≥n de estudiantes**: Revisi√≥n de registros hist√≥ricos de matr√≠cula por establecimiento
    2. **C√°lculo de percentiles**: Ordenamiento de estudiantes egresados de Ed. Media por rendimiento acad√©mico (NEM)
    3. **Seguimiento de trayectorias**: Vinculaci√≥n con registros de educaci√≥n superior
    4. **Selecci√≥n de instituci√≥n**: Cuando un estudiante tiene m√∫ltiples registros de matr√≠cula en educaci√≥n superior, se considera la **primera instituci√≥n** que aparece cronol√≥gicamente en los registros (ordenado por per√≠odo de matr√≠cula)
    5. **An√°lisis de patrones**: Identificaci√≥n de instituciones preferidas por segmento de rendimiento

    ### Consideraciones Importantes
    - **Percentiles de rendimiento**: Valores menores indican mejor rendimiento (percentil 10 = top 10%)
    - **Cobertura temporal**: Uso de datos desde 2005 hasta 2023 para el a√±o de egreso de Ed Media.
    - **Muestra**: M√°s de 50 establecimientos representativos de diferentes dependencias y regiones
    - **Limitaciones**: Solo incluye estudiantes que efectivamente se matricularon en educaci√≥n superior
    - **Criterio de instituci√≥n**: Se asigna la primera instituci√≥n de educaci√≥n superior en la que se matricul√≥ el estudiante, lo que puede representar su primera opci√≥n o decisi√≥n inicial

    ### Definici√≥n de Segmentos
    - **Mayor rendimiento**: Percentiles 10-30 (mejor 30% de estudiantes)
    - **Rendimiento intermedio**: Percentiles 40-70
    - **Menor rendimiento**: Percentiles 80-100 (20% con menor rendimiento)

    Los an√°lisis se enfocan en instituciones que concentran al menos el 66% de estudiantes en cada segmento.
  </script>
  <script id="48" type="text/x-typescript" hidden="">
    _.sortBy(establecimientosSeleccionados, d => d).map(d => d).join(",\n")
  </script>
  <script id="35" type="text/x-typescript">
    const establecimientosSeleccionados = [
    4,
    52,
    257,
    580,
    1194,
    1515,
    1757,
    2110,
    2200,
    2454,
    2786,
    2935,
    2973,
    3014,
    3247,
    4163,
    4798,
    4982,
    5084,
    5570,
    5654,
    5666,
    5810,
    7329,
    7406,
    8473,
    8485,
    8487,
    8748,
    8757,
    8862,
    8877,
    8888,
    8906,
    8917,
    8928,
    8979,
    8995,
    8996,
    9046,
    9267,
    9959,
    10832,
    10892,
    12669,
    16627,
    17600,
    17833,
    24685,
    25369,
    25439,
    25645,
    25654,
    25999,
    31327
    ]; // Add more RBDs as needed
  </script>
  <script id="12" type="application/sql" hidden="" database="duckdb" output="data_multiple_rbds">

    WITH estudiantes_rbd AS (
      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/4/NEM_y_Percentil_Jovenes_4.parquet'
      WHERE RBD = 4
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/52/NEM_y_Percentil_Jovenes_52.parquet'
      WHERE RBD = 52
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/257/NEM_y_Percentil_Jovenes_257.parquet'
      WHERE RBD = 257
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/580/NEM_y_Percentil_Jovenes_580.parquet'
      WHERE RBD = 580
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/1194/NEM_y_Percentil_Jovenes_1194.parquet'
      WHERE RBD = 1194
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/1515/NEM_y_Percentil_Jovenes_1515.parquet'
      WHERE RBD = 1515
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/1757/NEM_y_Percentil_Jovenes_1757.parquet'
      WHERE RBD = 1757
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/2110/NEM_y_Percentil_Jovenes_2110.parquet'
      WHERE RBD = 2110
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/2200/NEM_y_Percentil_Jovenes_2200.parquet'
      WHERE RBD = 2200
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/2454/NEM_y_Percentil_Jovenes_2454.parquet'
      WHERE RBD = 2454
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/2786/NEM_y_Percentil_Jovenes_2786.parquet'
      WHERE RBD = 2786
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/2935/NEM_y_Percentil_Jovenes_2935.parquet'
      WHERE RBD = 2935
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/2973/NEM_y_Percentil_Jovenes_2973.parquet'
      WHERE RBD = 2973
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/3014/NEM_y_Percentil_Jovenes_3014.parquet'
      WHERE RBD = 3014
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/3247/NEM_y_Percentil_Jovenes_3247.parquet'
      WHERE RBD = 3247
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/4163/NEM_y_Percentil_Jovenes_4163.parquet'
      WHERE RBD = 4163
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/4798/NEM_y_Percentil_Jovenes_4798.parquet'
      WHERE RBD = 4798
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/4982/NEM_y_Percentil_Jovenes_4982.parquet'
      WHERE RBD = 4982
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/5084/NEM_y_Percentil_Jovenes_5084.parquet'
      WHERE RBD = 5084
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/5570/NEM_y_Percentil_Jovenes_5570.parquet'
      WHERE RBD = 5570
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/5654/NEM_y_Percentil_Jovenes_5654.parquet'
      WHERE RBD = 5654
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/5666/NEM_y_Percentil_Jovenes_5666.parquet'
      WHERE RBD = 5666
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/5810/NEM_y_Percentil_Jovenes_5810.parquet'
      WHERE RBD = 5810
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/7329/NEM_y_Percentil_Jovenes_7329.parquet'
      WHERE RBD = 7329
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/7406/NEM_y_Percentil_Jovenes_7406.parquet'
      WHERE RBD = 7406
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8473/NEM_y_Percentil_Jovenes_8473.parquet'
      WHERE RBD = 8473
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8485/NEM_y_Percentil_Jovenes_8485.parquet'
      WHERE RBD = 8485
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8487/NEM_y_Percentil_Jovenes_8487.parquet'
      WHERE RBD = 8487
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8748/NEM_y_Percentil_Jovenes_8748.parquet'
      WHERE RBD = 8748
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8757/NEM_y_Percentil_Jovenes_8757.parquet'
      WHERE RBD = 8757
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8862/NEM_y_Percentil_Jovenes_8862.parquet'
      WHERE RBD = 8862
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8877/NEM_y_Percentil_Jovenes_8877.parquet'
      WHERE RBD = 8877
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8888/NEM_y_Percentil_Jovenes_8888.parquet'
      WHERE RBD = 8888
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8906/NEM_y_Percentil_Jovenes_8906.parquet'
      WHERE RBD = 8906
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8917/NEM_y_Percentil_Jovenes_8917.parquet'
      WHERE RBD = 8917
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8928/NEM_y_Percentil_Jovenes_8928.parquet'
      WHERE RBD = 8928
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8979/NEM_y_Percentil_Jovenes_8979.parquet'
      WHERE RBD = 8979
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8995/NEM_y_Percentil_Jovenes_8995.parquet'
      WHERE RBD = 8995
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8996/NEM_y_Percentil_Jovenes_8996.parquet'
      WHERE RBD = 8996
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/9046/NEM_y_Percentil_Jovenes_9046.parquet'
      WHERE RBD = 9046
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/9267/NEM_y_Percentil_Jovenes_9267.parquet'
      WHERE RBD = 9267
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/9959/NEM_y_Percentil_Jovenes_9959.parquet'
      WHERE RBD = 9959
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/10832/NEM_y_Percentil_Jovenes_10832.parquet'
      WHERE RBD = 10832
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/10892/NEM_y_Percentil_Jovenes_10892.parquet'
      WHERE RBD = 10892
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/12669/NEM_y_Percentil_Jovenes_12669.parquet'
      WHERE RBD = 12669
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/16627/NEM_y_Percentil_Jovenes_16627.parquet'
      WHERE RBD = 16627
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/17600/NEM_y_Percentil_Jovenes_17600.parquet'
      WHERE RBD = 17600
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/17833/NEM_y_Percentil_Jovenes_17833.parquet'
      WHERE RBD = 17833
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/24685/NEM_y_Percentil_Jovenes_24685.parquet'
      WHERE RBD = 24685
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/25369/NEM_y_Percentil_Jovenes_25369.parquet'
      WHERE RBD = 25369
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/25439/NEM_y_Percentil_Jovenes_25439.parquet'
      WHERE RBD = 25439
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/25645/NEM_y_Percentil_Jovenes_25645.parquet'
      WHERE RBD = 25645
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/25654/NEM_y_Percentil_Jovenes_25654.parquet'
      WHERE RBD = 25654
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/25999/NEM_y_Percentil_Jovenes_25999.parquet'
      WHERE RBD = 25999
      )
      UNION ALL

      (SELECT mrun,rbd,agno_egreso,percentil
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/31327/NEM_y_Percentil_Jovenes_31327.parquet'
      WHERE RBD = 31327
      )
    ),

    matriculas_rbd AS (
      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/4/Matricula_Ed_Superior_4.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/52/Matricula_Ed_Superior_52.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/257/Matricula_Ed_Superior_257.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/580/Matricula_Ed_Superior_580.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/1194/Matricula_Ed_Superior_1194.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/1515/Matricula_Ed_Superior_1515.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/1757/Matricula_Ed_Superior_1757.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/2110/Matricula_Ed_Superior_2110.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/2200/Matricula_Ed_Superior_2200.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/2454/Matricula_Ed_Superior_2454.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/2786/Matricula_Ed_Superior_2786.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/2935/Matricula_Ed_Superior_2935.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/2973/Matricula_Ed_Superior_2973.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/3014/Matricula_Ed_Superior_3014.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/3247/Matricula_Ed_Superior_3247.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/4163/Matricula_Ed_Superior_4163.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/4798/Matricula_Ed_Superior_4798.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/4982/Matricula_Ed_Superior_4982.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/5084/Matricula_Ed_Superior_5084.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/5570/Matricula_Ed_Superior_5570.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/5654/Matricula_Ed_Superior_5654.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/5666/Matricula_Ed_Superior_5666.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/5810/Matricula_Ed_Superior_5810.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/7329/Matricula_Ed_Superior_7329.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/7406/Matricula_Ed_Superior_7406.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8473/Matricula_Ed_Superior_8473.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8485/Matricula_Ed_Superior_8485.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8487/Matricula_Ed_Superior_8487.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8748/Matricula_Ed_Superior_8748.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8757/Matricula_Ed_Superior_8757.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8862/Matricula_Ed_Superior_8862.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8877/Matricula_Ed_Superior_8877.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8888/Matricula_Ed_Superior_8888.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8906/Matricula_Ed_Superior_8906.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8917/Matricula_Ed_Superior_8917.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8928/Matricula_Ed_Superior_8928.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8979/Matricula_Ed_Superior_8979.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8995/Matricula_Ed_Superior_8995.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/8996/Matricula_Ed_Superior_8996.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/9046/Matricula_Ed_Superior_9046.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/9267/Matricula_Ed_Superior_9267.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/9959/Matricula_Ed_Superior_9959.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/10832/Matricula_Ed_Superior_10832.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/10892/Matricula_Ed_Superior_10892.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/12669/Matricula_Ed_Superior_12669.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/16627/Matricula_Ed_Superior_16627.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/17600/Matricula_Ed_Superior_17600.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/17833/Matricula_Ed_Superior_17833.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/24685/Matricula_Ed_Superior_24685.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/25369/Matricula_Ed_Superior_25369.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/25439/Matricula_Ed_Superior_25439.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/25645/Matricula_Ed_Superior_25645.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/25654/Matricula_Ed_Superior_25654.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/25999/Matricula_Ed_Superior_25999.parquet')

      UNION ALL

      (SELECT mrun,cat_periodo,nomb_inst
      FROM 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main/31327/Matricula_Ed_Superior_31327.parquet')
    ),

    matriculas_con_percentil AS (
      SELECT
        nem.rbd,
        nem.mrun,
        agno_egreso,
        percentil::INT AS percentil,
        cat_periodo,
        nomb_inst
      FROM estudiantes_rbd nem
      JOIN matriculas_rbd es
        ON nem.mrun = es.mrun
    ),

    primera_matricula_por_estudiante AS (
      SELECT
        rbd,
        mrun,
        percentil,
        agno_egreso,
        MIN(cat_periodo) AS cat_periodo,
        FIRST(nomb_inst ORDER BY cat_periodo) AS nomb_inst
      FROM matriculas_con_percentil
      GROUP BY rbd, mrun, percentil, agno_egreso
    ),

    -- Calcular ranking de todas las instituciones por a√±o y RBD (basado en total de estudiantes)
    ranking_instituciones AS (
      SELECT
        rbd,
        agno_egreso,
        nomb_inst,
        COUNT(*) AS total_estudiantes,
        ROW_NUMBER() OVER (PARTITION BY rbd, agno_egreso ORDER BY COUNT(*) DESC) AS ranking_inst
      FROM primera_matricula_por_estudiante
      GROUP BY rbd, agno_egreso, nomb_inst
    ),

    -- Calcular top 5 instituciones por a√±o y RBD para percentiles <= 30
    top5_por_a√±o AS (
      SELECT
        rbd,
        agno_egreso,
        nomb_inst,
        SUM(CASE WHEN percentil <= 30 THEN 1 ELSE 0 END) AS estudiantes_top_deciles,
        ROW_NUMBER() OVER (PARTITION BY rbd, agno_egreso ORDER BY SUM(CASE WHEN percentil <= 30 THEN 1 ELSE 0 END) DESC) AS ranking_top_deciles
      FROM primera_matricula_por_estudiante
      GROUP BY rbd, agno_egreso, nomb_inst
    ),

    instituciones_top5 AS (
      SELECT
        rbd,
        agno_egreso,
        nomb_inst
      FROM top5_por_a√±o
      WHERE ranking_top_deciles <= 5
    ),

    datos_finales AS (
      SELECT
        rbd,
        agno_egreso,
        percentil,
        nomb_inst,
        COUNT(*) AS estudiantes
      FROM primera_matricula_por_estudiante
      GROUP BY rbd, agno_egreso, percentil, nomb_inst
    )

    SELECT
      df.rbd,
      df.agno_egreso,
      df.percentil,
      df.nomb_inst,
      df.estudiantes,
      ri.ranking_inst
    FROM datos_finales df
    LEFT JOIN ranking_instituciones ri
      ON df.rbd = ri.rbd
      AND df.agno_egreso = ri.agno_egreso
      AND df.nomb_inst = ri.nomb_inst
    ORDER BY df.rbd, df.agno_egreso, df.percentil, df.estudiantes DESC
  </script>
  <script id="45" type="module">
    const sqlQuery = sqlForSelected.queryCompleta;

    // Create a container with the query text and copy button
    const container = htl.html`<div style="border: 1px solid #ddd; border-radius: 4px; padding: 15px; background-color: #f8f9fa;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h4 style="margin: 0; color: #495057;">SQL Query Completa</h4>
        <button id="copyButton" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
          üìã Copy to Clipboard
        </button>
      </div>
      <!--
      <pre style="background-color: white; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px; line-height: 1.4; margin: 0; border: 1px solid #e9ecef;"><code>${sqlQuery}</code></pre>
      -->
    </div>`;

    // Add click event listener to the copy button
    container.querySelector('#copyButton').addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(sqlQuery);

        // Visual feedback
        const button = container.querySelector('#copyButton');
        const originalText = button.textContent;
        button.textContent = '‚úÖ Copied!';
        button.style.background = '#28a745';

        // Reset button after 2 seconds
        setTimeout(() => {
          button.textContent = originalText;
          button.style.background = '#007bff';
        }, 2000);

      } catch (err) {
        console.error('Failed to copy text: ', err);
        alert('Failed to copy to clipboard. Please copy manually.');
      }
    });

    //display(container);
  </script>
  <script id="44" type="module" hidden="">
    // Helper function to generate SQL UNION statements for multiple RBDs
    function generateUnionSQL(rbds, baseUrl = 'https://raw.githubusercontent.com/elaval/Datos-por-RBD/main') {

      // Generate estudiantes_rbd CTE
      const estudiantesUnions = rbds.map((rbd, index) => {
        const prefix = index === 0 ? '  (' : '\n  UNION ALL\n\n  (';
        return `${prefix}SELECT mrun,rbd,agno_egreso,percentil
      FROM '${baseUrl}/${rbd}/NEM_y_Percentil_Jovenes_${rbd}.parquet'
      WHERE RBD = ${rbd}
      )`;
      }).join('');

      // Generate matriculas_rbd CTE
      const matriculasUnions = rbds.map((rbd, index) => {
        const prefix = index === 0 ? '  (' : '\n\n  UNION ALL\n\n  (';
        return `${prefix}SELECT mrun,cat_periodo,nomb_inst
      FROM '${baseUrl}/${rbd}/Matricula_Ed_Superior_${rbd}.parquet')`;
      }).join('');

      return {
        estudiantesRbd: `WITH estudiantes_rbd AS (\n${estudiantesUnions}\n),`,
        matriculasRbd: `\nmatriculas_rbd AS (\n${matriculasUnions}\n),`,
        fullCTE: `WITH estudiantes_rbd AS (\n${estudiantesUnions}\n),\n\nmatriculas_rbd AS (\n${matriculasUnions}\n),`,

        queryCompleta: `
    WITH estudiantes_rbd AS (\n${estudiantesUnions}\n),\n\nmatriculas_rbd AS (\n${matriculasUnions}\n),

    matriculas_con_percentil AS (
      SELECT
        nem.rbd,
        nem.mrun,
        agno_egreso,
        percentil::INT AS percentil,
        cat_periodo,
        nomb_inst
      FROM estudiantes_rbd nem
      JOIN matriculas_rbd es
        ON nem.mrun = es.mrun
    ),

    primera_matricula_por_estudiante AS (
      SELECT
        rbd,
        mrun,
        percentil,
        agno_egreso,
        MIN(cat_periodo) AS cat_periodo,
        FIRST(nomb_inst ORDER BY cat_periodo) AS nomb_inst
      FROM matriculas_con_percentil
      GROUP BY rbd, mrun, percentil, agno_egreso
    ),

    -- Calcular ranking de todas las instituciones por a√±o y RBD (basado en total de estudiantes)
    ranking_instituciones AS (
      SELECT
        rbd,
        agno_egreso,
        nomb_inst,
        COUNT(*) AS total_estudiantes,
        ROW_NUMBER() OVER (PARTITION BY rbd, agno_egreso ORDER BY COUNT(*) DESC) AS ranking_inst
      FROM primera_matricula_por_estudiante
      GROUP BY rbd, agno_egreso, nomb_inst
    ),

    -- Calcular top 5 instituciones por a√±o y RBD para percentiles <= 30
    top5_por_a√±o AS (
      SELECT
        rbd,
        agno_egreso,
        nomb_inst,
        SUM(CASE WHEN percentil <= 30 THEN 1 ELSE 0 END) AS estudiantes_top_deciles,
        ROW_NUMBER() OVER (PARTITION BY rbd, agno_egreso ORDER BY SUM(CASE WHEN percentil <= 30 THEN 1 ELSE 0 END) DESC) AS ranking_top_deciles
      FROM primera_matricula_por_estudiante
      GROUP BY rbd, agno_egreso, nomb_inst
    ),

    instituciones_top5 AS (
      SELECT
        rbd,
        agno_egreso,
        nomb_inst
      FROM top5_por_a√±o
      WHERE ranking_top_deciles <= 5
    ),

    datos_finales AS (
      SELECT
        rbd,
        agno_egreso,
        percentil,
        nomb_inst,
        COUNT(*) AS estudiantes
      FROM primera_matricula_por_estudiante
      GROUP BY rbd, agno_egreso, percentil, nomb_inst
    )

    SELECT
      df.rbd,
      df.agno_egreso,
      df.percentil,
      df.nomb_inst,
      df.estudiantes,
      ri.ranking_inst
    FROM datos_finales df
    LEFT JOIN ranking_instituciones ri
      ON df.rbd = ri.rbd
      AND df.agno_egreso = ri.agno_egreso
      AND df.nomb_inst = ri.nomb_inst
    ORDER BY df.rbd, df.agno_egreso, df.percentil, df.estudiantes DESC`


      };
    }

    // Example usage with your current RBDs
    const currentRBDs = establecimientosSeleccionados;
    const sqlParts = generateUnionSQL(currentRBDs);

    // Display the generated SQL parts
    //display("Generated SQL for estudiantes_rbd:");
    //display(sqlParts.estudiantesRbd);

    //display("\nGenerated SQL for matriculas_rbd:");
    //display(sqlParts.matriculasRbd);

    //display("\nFull CTE (both parts combined):");
    //display(sqlParts.fullCTE);

    // You can also use it with your establecimientosSeleccionados array
    //display("\nUsing establecimientosSeleccionados:");
    const sqlForSelected = generateUnionSQL(establecimientosSeleccionados);

  </script>
  <script id="24" type="module">
    function getTopInstitutionsForLowPercentiles(rbd, agno_egreso, minPercentile = 0, maxPercentile = 30, majorityThreshold = 66) {
      // Filter data for the specified RBD and graduation year
      const filteredData = data_multiple_rbds.filter(d =>
        d.rbd == rbd && d.agno_egreso == agno_egreso
      );

      // Get data only for percentiles within the specified range
      const percentileRangeData = filteredData.filter(d =>
        d.percentil >= minPercentile && d.percentil <= maxPercentile
      );

      if (percentileRangeData.length === 0) {
        return {
          rbd: rbd,
          agno_egreso: agno_egreso,
          min_percentile: minPercentile,
          max_percentile: maxPercentile,
          majority_threshold: majorityThreshold,
          total_students_in_range: 0,
          institutions: [],
          summary: `No data found for RBD ${rbd} in year ${agno_egreso} for percentiles ${minPercentile}-${maxPercentile}`
        };
      }

      // Calculate total students in percentile range
      const totalStudentsInRange = _.sumBy(percentileRangeData, 'estudiantes');

      // Group by institution and sum students
      const institutionSummary = _.chain(percentileRangeData)
        .groupBy('nomb_inst')
        .map((group, institution) => {
          const totalStudents = _.sumBy(group, 'estudiantes');
          const percentage = (totalStudents / totalStudentsInRange) * 100;
          return {
            institution: institution,
            students: totalStudents,
            percentage: percentage,
            isMajority: percentage >= majorityThreshold
          };
        })
        .orderBy('students', 'desc')
        .value();

      // Get institutions with at least the threshold percentage of students
      const majorityInstitutions = institutionSummary.filter(inst => inst.isMajority);

      // If no single institution has majority, find combination that reaches the threshold
      let combinedMajorityInstitutions = [];
      if (majorityInstitutions.length === 0) {
        let cumulativePercentage = 0;
        for (const institution of institutionSummary) {
          combinedMajorityInstitutions.push(institution);
          cumulativePercentage += institution.percentage;
          if (cumulativePercentage >= majorityThreshold) {
            break;
          }
        }
      }

      // Create summary with institution names
      let summary;
      if (majorityInstitutions.length > 0) {
        const institutionNames = majorityInstitutions.map(inst =>
          `${inst.institution} (${inst.percentage.toFixed(1)}%)`
        ).join(', ');
        summary = `Institution(s) enrolling ‚â•${majorityThreshold}% of students in percentiles ${minPercentile}-${maxPercentile}: ${institutionNames}`;
      } else if (combinedMajorityInstitutions.length > 0) {
        const totalCombinedPercentage = _.sumBy(combinedMajorityInstitutions, 'percentage');
        const institutionNames = combinedMajorityInstitutions.map(inst =>
          `${inst.institution} (${inst.percentage.toFixed(1)}%)`
        ).join(', ');
        summary = `Top ${combinedMajorityInstitutions.length} institutions together enrolling ${totalCombinedPercentage.toFixed(1)}% of students in percentiles ${minPercentile}-${maxPercentile}: ${institutionNames}`;
      } else {
        summary = `No institutions found for percentiles ${minPercentile}-${maxPercentile}`;
      }

      return {
        rbd: rbd,
        agno_egreso: agno_egreso,
        min_percentile: minPercentile,
        max_percentile: maxPercentile,
        majority_threshold: majorityThreshold,
        total_students_in_range: totalStudentsInRange,
        institutions: institutionSummary,
        majority_institutions: majorityInstitutions.length > 0 ? majorityInstitutions : combinedMajorityInstitutions,
        is_combined_majority: majorityInstitutions.length === 0 && combinedMajorityInstitutions.length > 0,
        summary: summary
      };
    }

    // Example usage with current selections, percentile range [40,70] and 66% threshold
    const result = getTopInstitutionsForLowPercentiles(selectRBD, selectA√±o, 40, 70, 66);

    //display(result);
  </script>
  <script id="58" type="module">
    // Function to generate HTML list for institutions in each performance segment

    function generateInstitutionListHTML(rbd, agno_egreso, minPercentile, maxPercentile) {
      const data = getTopInstitutionsForLowPercentiles(rbd, agno_egreso, minPercentile, maxPercentile) ?? {};

      const total = data.total_students_in_range ?? 0;
      const list = Array.isArray(data.majority_institutions) ? data.majority_institutions : [];

      if (list.length === 0) {
        return html`
          <div class="institutions-container">
            <div class="no-data">
              <p>Ninguna instituci√≥n concentra la mayor√≠a</p>
              <small>Total estudiantes: ${total}</small>
            </div>
          </div>
        `;
      }

      // Build an array of DOM nodes for institutions
      const items = list.map(inst => html`
        <div class="institution-item">
          <div class="institution-name">${inst.institution}</div>
          <div class="institution-stats">
            <div class="institution-students">${inst.students} estudiantes</div>
            <div class="institution-percentage">${Number(inst.percentage).toFixed(1)}%</div>
          </div>
        </div>
      `);

      return html`
        <div class="institutions-container">
          ${items}
          <div class="total-students-badge">
            <small>Total del segmento: ${total} estudiantes</small>
          </div>
        </div>
      `;
    }
  </script>
  <script id="25" type="module">
    function generateInstitutionSummaryMD(rbd, agno_egreso) {
      // Get data for different percentile ranges
      const topPerformers = getTopInstitutionsForLowPercentiles(rbd, agno_egreso, 10, 30);
      const middlePerformers = getTopInstitutionsForLowPercentiles(rbd, agno_egreso, 40, 70);
      const lowPerformers = getTopInstitutionsForLowPercentiles(rbd, agno_egreso, 80, 100);

      // Helper function to create bullet list from majority institutions
      function createBulletList(institutionData) {
        if (!institutionData.majority_institutions || institutionData.majority_institutions.length === 0) {
          return "- Ninguna instituci√≥n concentra la mayor√≠a de estudiantes";
        }

        return institutionData.majority_institutions
          .map(inst => `- ${inst.institution} (${inst.percentage.toFixed(1)}%)`)
          .join('\n');
      }

      // Generate markdown text
      const markdownText = `## Instituciones seleccionadas por mayor√≠a de estudiantes

    **En los mejores percentiles de rendimiento escolar (10 a 30):**
    ${createBulletList(topPerformers)}

    **En percentiles intermedios (40 a 70):**
    ${createBulletList(middlePerformers)}

    **En los percentiles de menor rendimiento escolar (80 a 100):**
    ${createBulletList(lowPerformers)}`;

      return markdownText;
    }

    // Generate summary for current selections
    const institutionSummaryMD = generateInstitutionSummaryMD(selectRBD, selectA√±o);

    //display(institutionSummaryMD);
  </script>
  <script id="22" type="module">
    // Create download button for CSV export
    const downloadButton = htl.html`<button style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">
      Download CSV
    </button>`;

    // Function to convert data to CSV
    function downloadCSV(data, filename) {
      if (!data || data.length === 0) {
        alert('No data to export');
        return;
      }

      // Get headers from the first object
      const headers = Object.keys(data[0]);

      // Create CSV content
      const csvContent = [
        headers.join(','), // Header row
        ...data.map(row =>
          headers.map(header => {
            const value = row[header];
            // Handle values that might contain commas or quotes
            if (typeof value === 'string' && (value.includes(',') || value.includes('"') || value.includes('\n'))) {
              return `"${value.replace(/"/g, '""')}"`;
            }
            return value;
          }).join(',')
        )
      ].join('\n');

      // Create and trigger download
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Add click event listener
    downloadButton.onclick = () => {
      downloadCSV(data_multiple_rbds, 'data_multiple_rbds.csv');
    };

    //display(downloadButton);
    //display(`Dataset contains ${data_multiple_rbds.length} rows`);
  </script>
  <script id="37" type="text/x-typescript">
    const dbDirectorio = await DuckDBClient.of({
      dir: FileAttachment("directorio_escolar_2024.parquet")
    });

    const dirQuery = `
    SELECT RBD, NOM_RBD, NOM_COM_RBD, COD_DEPE2
    FROM dir
    WHERE RBD in (${establecimientosSeleccionados.map(d => d).join(",")})
    `;

    const establecimientos = await dbDirectorio.query(dirQuery);
    const dictEstablecimientos = {};
    [...establecimientos].forEach(d => dictEstablecimientos[d.RBD] = d);

  </script>
  <script id="55" type="module" hidden="">
    // Mapping function for school dependency types
    function getDependenciaName(codDepe2) {
      const dependenciaMap = {
        1: "Municipal",
        2: "Particular Subvencionado",
        3: "Particular Pagado",
        4: "Administraci√≥n Delegada",
        5: "Servicio Local"
      };
      return dependenciaMap[codDepe2] || "No especificado";
    }
  </script>
  <script id="59" type="text/html">
    <style>
      .performance-segments {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 16px;
        margin-top: 20px;
      }

      .segment-column {
        background: white;
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        border: 1px solid #e9ecef;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .segment-column:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0,0,0,0.12);
      }

      .segment-column.high-performance {
        border-top: 3px solid #27ae60;
      }

      .segment-column.medium-performance {
        border-top: 3px solid #f39c12;
      }

      .segment-column.low-performance {
        border-top: 3px solid #e74c3c;
      }

      .segment-header {
        text-align: center;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid #f1f3f4;
      }

      .segment-header h4 {
        margin: 0 0 4px 0;
        font-size: 1.05em;
        font-weight: 600;
        color: #2c3e50;
        line-height: 1.3;
        min-height: 2.6em;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .segment-header .percentile-range {
        font-size: 0.85em;
        color: #6c757d;
        font-weight: 400;
        display: block;
        margin-top: 4px;
      }

      .institutions-container {
        min-height: 120px;
      }

      .institution-item {
        background: #f8f9fa;
        border-radius: 6px;
        padding: 10px;
        margin-bottom: 8px;
        border-left: 3px solid #dee2e6;
        transition: all 0.2s ease;
      }

      .institution-item:hover {
        background: #e9ecef;
        border-left-color: #6c757d;
      }

      .institution-name {
        font-weight: 500;
        color: #495057;
        font-size: 0.9em;
        line-height: 1.3;
        margin-bottom: 4px;
      }

      .institution-stats {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.8em;
        color: #6c757d;
      }

      .institution-students {
        font-weight: 500;
      }

      .institution-percentage {
        background: #e9ecef;
        padding: 2px 6px;
        border-radius: 10px;
        font-weight: 500;
      }

      .no-data {
        text-align: center;
        color: #6c757d;
        font-style: italic;
        padding: 20px;
      }

      .no-data p {
        margin: 0 0 8px 0;
        font-size: 0.9em;
      }

      .no-data small {
        font-size: 0.8em;
        color: #adb5bd;
      }

      @media (max-width: 768px) {
        .performance-segments {
          grid-template-columns: 1fr;
          gap: 12px;
        }
      }
    </style>
  </script>
  <script id="29" type="text/html">
    <style>
      .notebook-container {
        max-width: 1200px;
        margin: 0 auto;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      }

      h1 {
        color: #2c3e50;
        border-bottom: 3px solid #3498db;
        padding-bottom: 10px;
        margin-bottom: 30px;
      }

      h2 {
        color: #34495e;
        margin-top: 40px;
        margin-bottom: 20px;
      }

      h3 {
        color: #7f8c8d;
        margin-top: 30px;
        margin-bottom: 15px;
      }

      .controls-section {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
        border-left: 4px solid #3498db;
      }

      .chart-container {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin: 20px 0;
      }

      .summary-section {
        background-color: #f1f8ff;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
        border-left: 4px solid #0366d6;
      }

      .methodology-section {
        background-color: #fafafa;
        padding: 25px;
        border-radius: 8px;
        margin: 30px 0;
        border: 1px solid #e1e4e8;
      }

      ul {
        line-height: 1.6;
      }

      li {
        margin-bottom: 8px;
      }

      hr {
        border: none;
        height: 2px;
        background: linear-gradient(to right, #3498db, transparent);
        margin: 40px 0;
      }
    </style>
  </script>
  <script id="33" type="text/html">
       <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@observablehq/framework@latest/dist/framework.css">
  </script>
</notebook>
